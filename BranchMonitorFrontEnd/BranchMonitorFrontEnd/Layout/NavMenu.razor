@using BranchMonitorFrontEnd.DTO
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavigationManager
@inject LayoutSharedService SharedService
@implements IDisposable
@inject AuthCredential _auth

@if (User == null)
{
    <span>..loding </span>
}
else
{
    @if (User.status == false)
    {
        <span>Authontiction Field ...</span>

    }
    else
    {
        <!-- Top Navigation Bar -->
        <nav class="modern-navbar">
            <div class="navbar-container">
                <!-- Left Section: Logo & Menu Toggle -->
                <div class="navbar-left">
                    <button class="menu-toggle-btn" @onclick="ToggleSidebar" aria-label="Toggle menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>

                    <div class="navbar-brand">
                        <div class="brand-logo">
                            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#953e3f;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#b04e4f;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <polygon points="50,5 95,27.5 95,72.5 50,95 5,72.5 5,27.5" fill="url(#logoGrad)" stroke="#953e3f" stroke-width="2" />
                                <rect x="30" y="30" width="40" height="28" rx="2" fill="white" opacity="0.9" />
                                <line x1="36" y1="64" x2="44" y2="64" stroke="white" stroke-width="2" opacity="0.9" />
                                <line x1="40" y1="58" x2="40" y2="64" stroke="white" stroke-width="2" opacity="0.9" />
                            </svg>
                        </div>
                        <div class="brand-text">
                            <h1>Kiosk Monitor</h1>
                            <span class="brand-subtitle">Dashboard</span>
                        </div>
                    </div>
                </div>

                <!-- Center Section: Search -->
                @* <div class="navbar-center">
                    <div class="search-container">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="search-icon">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text"
                               placeholder="Search kiosks, branches..."
                               class="search-input"
                               @bind="searchQuery"
                               @oninput="OnSearchInput" />
                        <kbd class="search-shortcut">Ctrl+K</kbd>
                    </div>
                </div> *@

                <!-- Right Section: Actions & User -->
                <div class="navbar-right">
                    <!-- Notifications -->
                    <button class="navbar-icon-btn" title="Notifications">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-badge">3</span>
                    </button>

                    <!-- Settings -->
                    <button class="navbar-icon-btn" title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.196-13.804l-4.242 4.242m-5.908 5.908l-4.242 4.242m15.15-10.606l-4.242 4.242m-5.908 5.908l-4.242 4.242"></path>
                        </svg>
                    </button>

                    <!-- User Profile -->
                    <div class="user-profile-container">
                        <div class="user-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="user-info">
                            <span class="user-name">@User.UserName</span>
                            <span class="user-role">@User.Role</span>
                        </div>
                    </div>

                    <!-- Logout -->
                    <button class="logout-btn" @onclick="HandleLogout" title="Logout">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay @(sidebarOpen ? "active" : "")" @onclick="CloseSidebar"></div>

        <!-- Modern Sidebar -->
        <aside class="modern-sidebar @(sidebarOpen ? "open" : "")">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="50,5 95,27.5 95,72.5 50,95 5,72.5 5,27.5" fill="#953e3f" />
                        <rect x="30" y="30" width="40" height="28" rx="2" fill="white" opacity="0.9" />
                    </svg>
                </div>
                <h2>@currentTitle</h2>
                <button class="sidebar-close-btn" @onclick="CloseSidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="sidebar-content">
                @if (isLoading)
                {
                    <Loder Height="20px" width="20px" />

                }
                else if (filteredMenuItems?.Any() == true)
                {
                    <nav class="sidebar-nav">
                        @foreach (var menu in filteredMenuItems)
                        {
                            <div class="nav-item-wrapper @(menu.IsExpanded ? "expanded" : "")">
                                @if (menu.HasSubMenu)
                                {
                                    <button class="nav-item" @onclick="@(() => ToggleSubmenu(menu))">
                                        <i class="@menu.Icon"></i>
                                        <span>@menu.Name</span>
                                        <svg class="submenu-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </button>

                                    @if (menu.SubMenus?.Any() == true)
                                    {
                                        <div class="submenu">
                                            @foreach (var subMenu in menu.SubMenus)
                                            {
                                                <NavLink href="@subMenu.URL" class="submenu-item" @onclick="@(() => OnMenuItemClick(subMenu.Name))">
                                                    <i class="@subMenu.Icon"></i>
                                                    <span>@subMenu.Name</span>
                                                </NavLink>
                                            }
                                        </div>
                                    }
                                }
                                else
                                {
                                    <NavLink href="@menu.URL" class="nav-item" Match="NavLinkMatch.All" @onclick="@(() => OnMenuItemClick(menu.Name))">
                                        <i class="@menu.Icon"></i>
                                        <span>@menu.Name</span>
                                    </NavLink>
                                }
                            </div>
                        }
                    </nav>
                }
            </div>

            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="sidebar-user-info">
                        <span class="sidebar-user-name">@User.UserName</span>
                        <span class="sidebar-user-role">@User.Role</span>
                    </div>
                </div>
            </div>
        </aside>
    }
}



@code {
    private bool sidebarOpen = false;
    private bool isLoading = false;
    private string searchQuery = string.Empty;
    private string currentTitle = "Main Menu";

    private List<MenuModel> menuItems = new();
    private List<MenuModel> filteredMenuItems = new();
    private UserInfo currentUser = new("Admin User", "Administrator");


    private LoggedInUser User { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {

            User = await _auth.getLogginUserDetiles();

            SharedService.OnMessage += HandleMenuChange;
            InitializeMenuData();
            filteredMenuItems = menuItems;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred during initialization: {ex.Message}");
        }


    }

    // User logout 
    private async Task HandleLogout()
    {
        await _auth.UserLogOut();
        NavigationManager.NavigateTo("/");
    }

    private void InitializeMenuData()
    {
        menuItems = new List<MenuModel>
        {
            new MenuModel { Id = "1", Name = "Dashboard", URL = "/dashboard", Icon = "fas fa-tachometer-alt", HasSubMenu = false },
            
            // new MenuModel { Id = "2", Name = "Events", URL = "/events", Icon = "fas fa-map-marker-alt", HasSubMenu = false },
            new MenuModel { Id = "3", Name = "All Branches", URL = "/branches", Icon = "fas fa-map-marker-alt", HasSubMenu = false },
       new MenuModel
{
    Id = "4",
    Name = "Patch Updates",
    URL = "/patchupdate",
    Icon = "fas fa-desktop",
    HasSubMenu = true,
    SubMenus = new List<SubMenuModel>
    {
        new SubMenuModel
        {
            Name = "File Server Patch Push",
            URL = "/patchupdate/fileserver",
            Icon = "fas fa-server"
        },
        new SubMenuModel
        {
            Name = "Patch Update All Branch",
            URL = "/patchupdate/patch-update-all-Branch",
            Icon = "fas fa-desktop"
        },
        new SubMenuModel
        {
            Name = "Patch History",
            URL = "/patchupdate/history",
            Icon = "fas fa-history"
        }
    }
},

            new MenuModel {
                Id = "5",
                Name = "Analytics",
                URL = "#",
                Icon = "fas fa-chart-line",
                HasSubMenu = true,
                SubMenus = new List<SubMenuModel>
                {
                    new SubMenuModel { Name = "Health Analytics", URL = "/health-analytics", Icon = "fas fa-heartbeat" },
                    new SubMenuModel { Name = "Reports", URL = "/reports", Icon = "fas fa-file-alt" },
                    new SubMenuModel { Name = "Logs", URL = "/logs", Icon = "fas fa-file-contract" }
                }
            },

             new MenuModel {
                Id = "6",
                Name = "Setting",
                URL = "#",
                Icon = "fas fa-chart-line",
                HasSubMenu = true,
                SubMenus = new List<SubMenuModel>
                {
                    new SubMenuModel { Name = "Add New Branch", URL = "/setting/add-new-branch", Icon = "fas fa-heartbeat" },
                    new SubMenuModel { Name = "Add New User", URL = "/setting/add-new-user", Icon = "fas fa-file-alt" },
                    // new SubMenuModel { Name = "Logs", URL = "/logs", Icon = "fas fa-file-contract" }
                }
            },
            // new MenuModel { Id = "6", Name = "Users", URL = "/users", Icon = "fas fa-users", HasSubMenu = false },
            // new MenuModel { Id = "7", Name = "Settings", URL = "/settings", Icon = "fas fa-cog", HasSubMenu = false }
        };
    }

    private void HandleMenuChange(int menuId)
    {
        if (menuId <= 0) return;
        currentTitle = SharedService.GetMessage();
        StateHasChanged();
    }

    private void ToggleSidebar() => sidebarOpen = !sidebarOpen;
    private void CloseSidebar() => sidebarOpen = false;

    private void ToggleSubmenu(MenuModel menu)
    {
        menu.IsExpanded = !menu.IsExpanded;
        foreach (var otherMenu in menuItems.Where(m => m != menu && m.HasSubMenu))
        {
            otherMenu.IsExpanded = false;
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? string.Empty;
        FilterMenuItems();
    }

    private void FilterMenuItems()
    {
        filteredMenuItems = string.IsNullOrWhiteSpace(searchQuery)
            ? menuItems
            : menuItems.Where(m => m.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private void OnMenuItemClick(string menuName)
    {
        if (sidebarOpen) CloseSidebar();
    }

   

    public void Dispose()
    {
        SharedService.OnMessage -= HandleMenuChange;
    }

    private class MenuModel
    {
        public string Id { get; set; } = string.Empty;
        public string URL { get; set; } = string.Empty;
        public string Icon { get; set; } = "fas fa-circle";
        public string Name { get; set; } = string.Empty;
        public bool HasSubMenu { get; set; }
        public bool IsExpanded { get; set; }
        public List<SubMenuModel> SubMenus { get; set; } = new();
    }

    private class SubMenuModel
    {
        public string URL { get; set; } = string.Empty;
        public string Icon { get; set; } = "fas fa-circle";
        public string Name { get; set; } = string.Empty;
    }

    private record UserInfo(string Name, string Role);

    public class LayoutSharedService
    {
        private string text = string.Empty;
        public event Action<int>? OnMessage;
        public void Change(int message, string TitleMsg)
        {
            text = TitleMsg;
            OnMessage?.Invoke(message);
        }
        public string GetMessage() => text;
    }
}


        <style>
    .nav-item-wrapper {
        margin-bottom: 2px;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: none;
        border: none;
        border-radius: 10px;
        color: #999;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        text-align: left;
    }

        .nav-item:hover {
            background: rgba(149, 62, 63, 0.1);
            color: #ffffff;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #953e3f 0%, #b04e4f 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(149, 62, 63, 0.3);
        }

        .nav-item i {
            width: 20px;
            font-size: 16px;
        }

    .submenu-arrow {
        margin-left: auto;
        width: 16px;
        height: 16px;
        transition: transform 0.3s ease;
    }

    .nav-item-wrapper.expanded .submenu-arrow {
        transform: rotate(90deg);
    }

    .submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .nav-item-wrapper.expanded .submenu {
        max-height: 500px;
    }

    .nav-item,
    .submenu-item {
        animation: fadeIn 0.3s ease-out;
    }

        /* Focus States for Accessibility */
        .menu-toggle-btn:focus,
        .navbar-icon-btn:focus,
        .logout-btn:focus,
        .nav-item:focus,
        .submenu-item:focus {
            outline: 2px solid #953e3f;
            outline-offset: 2px;
        }

    .submenu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px 10px 48px;
        color: #666;
        text-decoration: none;
        font-size: 13px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

        .submenu-item:hover {
            background: rgba(149, 62, 63, 0.1);
            color: #ffffff;
        }

        .submenu-item.active {
            background: rgba(149, 62, 63, 0.2);
            color: #ffffff;
        }

        </style>