@page "/patchupdate/x"
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS

<div class="upload-card d-flex flex-column mt-5">
    <div class="d-flex">
        <div class="row col-12">
            <div class="upload-header col-3">
                <h2>Upload Patch File</h2>
            </div>
        </div>
    </div>

    <div @ref="dropZoneElement"
         class="upload-area @(isDragging ? "dragging" : "")"
         @ondragenter="HandleDragEnter"
         @ondragleave="HandleDragLeave"
         @ondragover:preventDefault>

        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="upload-icon">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>

        <h3>Drag & Drop patch file here</h3>
        <p>or click to browse</p>

        <button class="btn-upload" type="button" @onclick:stopPropagation="true" @onclick="TriggerFileInput">
            Choose File
        </button>

        <span class="file-types">Supported: .msi, .exe, .zip</span>
    </div>

    <InputFile OnChange="HandleFileSelected"
               @ref="inputFile"
               id="fileInput"
               style="display: none;"
                />

    @if (!string.IsNullOrEmpty(uploadedFileName))
    {
        <div class="uploaded-file">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
            </svg>

            <div class="file-info">
                <span class="file-name">@uploadedFileName</span>
                <span class="file-size">@uploadedFileSize MB</span>
            </div>

            <button class="btn-remove" type="button" @onclick="RemoveFile">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
    }

    @if (isUploading)
    {
        <div class="upload-progress">
            <div class="progress-bar">
                <div class="progress-fill" style="width: @uploadProgress%"></div>
            </div>
            <span class="progress-text">@uploadProgress% Uploaded</span>
        </div>
    }

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message @statusClass">
            @statusMessage
        </div>
    }
</div>

@code {
    private ElementReference dropZoneElement;
    private InputFile? inputFile;

    private bool isDragging = false;
    private string uploadedFileName = string.Empty;
    private string uploadedFileSize = string.Empty;
    private bool isUploading = false;
    private int uploadProgress = 0;
    private string statusMessage = string.Empty;
    private string statusClass = string.Empty;
    private IBrowserFile? selectedFile;

    private readonly string[] allowedExtensions = { "*" };
    private const long maxFileSize = 5_000L * 1024L * 1024L; // 500 MB

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initializeFileUpload", dropZoneElement, "fileInput");
        }
    }

    private void HandleDragEnter()
    {
        isDragging = true;
    }

    private void HandleDragLeave()
    {
        isDragging = false;
    }

    private async Task TriggerFileInput()
    {
        await JS.InvokeVoidAsync("triggerFileInput", "fileInput");
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        isDragging = false;
        selectedFile = e.File;

        if (selectedFile == null)
            return;

        // Validate file extension
        var extension = Path.GetExtension(selectedFile.Name).ToLowerInvariant();
        // if (!allowedExtensions.Contains(extension))
        // {
        //     statusMessage = $"Invalid file type. Only {string.Join(", ", allowedExtensions)} files are allowed.";
        //     statusClass = "error";
        //     selectedFile = null;
        //     uploadedFileName = string.Empty;
        //     uploadedFileSize = string.Empty;
        //     return;
        // }

        // Validate file size
        // if (selectedFile.Size > maxFileSize)
        // {
        //     statusMessage = $"File size exceeds maximum allowed size of {maxFileSize / (1024 * 1024)} MB.";
        //     statusClass = "error";
        //     selectedFile = null;
        //     uploadedFileName = string.Empty;
        //     uploadedFileSize = string.Empty;
        //     return;
        // }

        // Display file info
        uploadedFileName = selectedFile.Name;
        uploadedFileSize = (selectedFile.Size / (1024.0 * 1024.0)).ToString("F2");
        statusMessage = string.Empty;
        statusClass = string.Empty;

        // Automatically start upload
        await UploadFile();
    }

    private async Task UploadFile()
    {
        if (selectedFile == null)
            return;

        try
        {
            isUploading = true;
            uploadProgress = 0;
            statusMessage = "Uploading file...";
            statusClass = string.Empty;

            // Define upload directory
            var uploadPath = Path.Combine(Environment.CurrentDirectory, "Uploads", "Patches");

            // Create directory if it doesn't exist
            if (!Directory.Exists(uploadPath))
            {
                Directory.CreateDirectory(uploadPath);
            }

            // Generate unique filename
            var timestamp = DateTime.Now.ToString("yyyyMMddHHmmss");
            var fileName = $"{Path.GetFileNameWithoutExtension(selectedFile.Name)}_{timestamp}{Path.GetExtension(selectedFile.Name)}";
            var filePath = Path.Combine(uploadPath, fileName);

            // Read and save the file with progress
            var buffer = new byte[512000]; // 500KB buffer
            using var stream = selectedFile.OpenReadStream(maxFileSize);
            using var fs = new FileStream(filePath, FileMode.Create);

            int bytesRead;
            long totalBytesRead = 0;

            while ((bytesRead = await stream.ReadAsync(buffer)) > 0)
            {
                await fs.WriteAsync(buffer.AsMemory(0, bytesRead));
                totalBytesRead += bytesRead;

                // Update progress
                uploadProgress = (int)((totalBytesRead * 100) / selectedFile.Size);
                StateHasChanged();

                // Small delay to show progress smoothly
                await Task.Delay(10);
            }

            uploadProgress = 100;
            statusMessage = $"File uploaded successfully! Saved to: {filePath}";
            statusClass = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"Upload failed: {ex.Message}";
            statusClass = "error";
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private void RemoveFile()
    {
        selectedFile = null;
        uploadedFileName = string.Empty;
        uploadedFileSize = string.Empty;
        uploadProgress = 0;
        statusMessage = string.Empty;
        statusClass = string.Empty;
    }
}

<style>
    /* Upload Section */
    .upload-card {
        background: linear-gradient(135deg, #3e3e3f 0%, #2f2f30 100%);
        border: 2px solid rgba(100, 98, 100, 0.3);
        border-radius: 16px;
        padding: 30px;
        max-width: 800px;
        margin: 0 auto;
    }

    .upload-header h2 {
        font-size: 20px;
        color: #ffffff;
        font-weight: 700;
        margin: 0 0 24px 0;
    }

    .upload-area {
        border: 2px dashed rgba(100, 98, 100, 0.4);
        border-radius: 14px;
        padding: 50px 30px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .upload-area:hover,
        .upload-area.dragging {
            border-color: #953e3f;
            background: rgba(149, 62, 63, 0.05);
        }

    .upload-icon {
        width: 60px;
        height: 60px;
        color: #666;
        margin: 0 auto 20px;
        display: block;
    }

    .upload-area h3 {
        font-size: 18px;
        color: #ffffff;
        margin: 0 0 8px 0;
    }

    .upload-area p {
        font-size: 14px;
        color: #666;
        margin: 0 0 20px 0;
    }

    .btn-upload {
        padding: 12px 32px;
        background: linear-gradient(135deg, #953e3f 0%, #b04e4f 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(149, 62, 63, 0.4);
        }

    .file-types {
        display: block;
        margin-top: 16px;
        font-size: 12px;
        color: #666;
    }

    .uploaded-file {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 20px;
        padding: 16px;
        background: rgba(149, 62, 63, 0.1);
        border: 1px solid rgba(149, 62, 63, 0.3);
        border-radius: 10px;
    }

        .uploaded-file svg {
            width: 32px;
            height: 32px;
            color: #953e3f;
            flex-shrink: 0;
        }

    .file-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .file-name {
        font-size: 14px;
        color: #ffffff;
        font-weight: 600;
    }

    .file-size {
        font-size: 12px;
        color: #666;
    }

    .btn-remove {
        width: 32px;
        height: 32px;
        background: rgba(149, 62, 63, 0.2);
        border: 1px solid rgba(149, 62, 63, 0.3);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .btn-remove:hover {
            background: rgba(149, 62, 63, 0.3);
            transform: rotate(90deg);
        }

        .btn-remove svg {
            width: 16px;
            height: 16px;
            color: #953e3f;
        }

    /* Upload Progress */
    .upload-progress {
        margin-top: 20px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(100, 98, 100, 0.3);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #953e3f 0%, #b04e4f 100%);
        transition: width 0.3s ease;
    }

    .progress-text {
        display: block;
        text-align: center;
        font-size: 13px;
        color: #ffffff;
        font-weight: 500;
    }

    /* Status Messages */
    .status-message {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
    }

        .status-message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.4);
            color: #4caf50;
        }

        .status-message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.4);
            color: #f44336;
        }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .upload-area {
            padding: 30px 20px;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
        }

        .upload-area h3 {
            font-size: 16px;
        }

        .btn-upload {
            padding: 10px 24px;
            font-size: 13px;
        }
    }
</style>

<script>
    window.initializeFileUpload = (dropZone, inputId) => {
        const inputElement = document.getElementById(inputId);

        if (!dropZone || !inputElement) {
            console.error('Drop zone or input element not found');
            return;
        }

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Handle dropped files
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                inputElement.files = files;
                const event = new Event('change', { bubbles: true });
                inputElement.dispatchEvent(event);
            }
        }, false);

        // Click anywhere in drop zone to open file browser
        dropZone.addEventListener('click', (e) => {
            // Don't trigger if clicking the button itself
            if (e.target.tagName !== 'BUTTON') {
                inputElement.click();
            }
        });
    };

    window.triggerFileInput = (inputId) => {
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.click();
        }
    };
</script>
