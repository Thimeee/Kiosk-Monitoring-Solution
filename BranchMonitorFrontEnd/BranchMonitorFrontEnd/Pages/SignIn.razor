@page "/"
@using System.ComponentModel.DataAnnotations
@using BranchMonitorFrontEnd.DTO
@* @inject AuthenticationService AuthService *@
@inject NavigationManager Navigation
@layout LogInLayout
@using BranchMonitorFrontEnd.Service.Auth
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@using System.Net.Http.Json
@using Monitoring.Shared.DTO
@inject HttpClient Http
@inject IJSRuntime JS
@inject AlertService AlertService
@inject AuthenticationStateProvider AuthStateProvider
@inject AuthCredential _auth
@inject AppSettings Settings





<div class="login-wrapper">
    <div class="animated-background">
        <div class="circle circle-1"></div>
        <div class="circle circle-2"></div>
        <div class="circle circle-3"></div>
        <div class="circle circle-4"></div>
        <div class="grid-overlay"></div>
    </div>

    <div class="login-container " >
        <div class="login-box">
            <div class="login-header">
                <div class="brand-logo">
                    <div class="logo-hexagon">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#953e3f;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#c54e4f;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <polygon points="50,5 95,27.5 95,72.5 50,95 5,72.5 5,27.5"
                                     fill="url(#logoGradient)" stroke="#953e3f" stroke-width="2" />
                            <rect x="30" y="30" width="40" height="28" rx="2" fill="white" opacity="0.9" />
                            <line x1="36" y1="64" x2="44" y2="64" stroke="white" stroke-width="2" opacity="0.9" />
                            <line x1="40" y1="58" x2="40" y2="64" stroke="white" stroke-width="2" opacity="0.9" />
                            <line x1="35" y1="38" x2="50" y2="38" stroke="#3e3e3f" stroke-width="2" />
                            <line x1="35" y1="45" x2="60" y2="45" stroke="#3e3e3f" stroke-width="2" />
                        </svg>
                    </div>
                    <div class="brand-text">
                        <h1>KIOSK MONITOR</h1>
                        <span class="brand-subtitle">Enterprise Management System</span>
                    </div>
                </div>
               
               
            </div>

          
            <EditForm Model="@loginModel" OnValidSubmit="HandleLogin" class="login-form">
                <DataAnnotationsValidator />

                <div class="form-field">
                    <label class="field-label">
                        <svg xmlns="" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Username
                    </label>
                    <div class="input-wrapper">
                        <InputText id="username" @bind-Value="loginModel.Username"
                                   class="field-input"
                                   placeholder="Enter your username"
                                   autocomplete="username" />
                        <div class="input-glow"></div>
                    </div>
                    <ValidationMessage For="@(() => loginModel.Username)" class="field-error" />
                </div>

                <div class="form-field">
                    <label class="field-label">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        Password
                    </label>
                    <div class="input-wrapper password-wrapper">
                        <InputText id="password"
                                   type="@(showPassword ? "text" : "password")"
                                   @bind-Value="loginModel.Password"
                                   class="field-input"
                                   placeholder="Enter your password"
                                   autocomplete="current-password" />
                        <button type="button" class="password-toggle" @onclick="TogglePassword" tabindex="-1">
                            @if (showPassword)
                            {
                                <svg  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                    <line x1="1" y1="1" x2="23" y2="23"></line>
                                </svg>
                            }
                            else
                            {
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            }
                        </button>
                        <div class="input-glow"></div>
                    </div>
                    <ValidationMessage For="@(() => loginModel.Password)" class="field-error" />
                </div>

                <div class="form-extras">
                    <label class="checkbox-container">
                        <InputCheckbox @bind-Value="loginModel.RememberMe" />
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-label">Keep me signed in</span>
                    </label>
                </div>


               <button type="submit" class="submit-button" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="button-spinner"></span>
                        <span>Authenticating...</span>
                    }
                    else
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                            <polyline points="10 17 15 12 10 7"></polyline>
                            <line x1="15" y1="12" x2="3" y2="12"></line>
                        </svg>
                        <span>Sign In to Dashboard</span>
                    }
                </button>
            </EditForm>  
        </div>

      
    </div>
</div>

@* Alert  *@
<AlertContainer />


@code {
    private LoginModel loginModel = new();
    private bool showPassword = false;
    private bool isLoading = false;

    private LoggedInUser User { get; set; }
    private LogInBranchDeties Branch { get; set; }


    // check Uthorize User Login 

    protected override async Task OnInitializedAsync()
    {
        try
        {
            User = await _auth.getLogginUserDetiles();
            Branch = await _auth.getLogginBranchDetiles();
            if (User != null || Branch != null)
            {
                switch ((User?.status, Branch?.status))
                {
                    case (true, true):
                        Navigation.NavigateTo("/branchDashbord");

                        break;
                    case (false, true):
                        Navigation.NavigateTo("/");
                        break;
                    case (true, false):
                        Navigation.NavigateTo("/dashboard");

                        break;
                    case (false, false):
                        Navigation.NavigateTo("/");

                        break;
                }

            }

        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred during initialization: {ex.Message}");
        }


    }
    // check Uthorize User Login


    private void TogglePassword()
    {
        showPassword = !showPassword;
    }

    // Login process 

    private async Task HandleLogin()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            if (Settings.MainApiBaseUrl != null)
            {
                var response = await Http.PostAsJsonAsync($"{Settings.MainApiBaseUrl}api/auth/login",
          new { loginModel.Username, loginModel.Password, loginModel.RememberMe });

                var result = await response.Content.ReadFromJsonAsync<APIResponseSingleValue>();

                if (response.IsSuccessStatusCode)
                {

                    if (result != null && result.StatusCode == 2 && result.Status == true)
                    {
                        await JS.InvokeVoidAsync("localStorage.setItem", "authToken", result.Value);

                        // Notify authentication state changed
                        if (AuthStateProvider is CustomAuthStateProvider customAuth)
                        {
                            customAuth.NotifyAuthenticationStateChanged();
                        }
                        Navigation.NavigateTo("/dashboard");
                    }
                }
                else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized || response.StatusCode == System.Net.HttpStatusCode.BadRequest)
                {
                    if (result != null && result.StatusCode == 1 && result.Status == false)
                    {
                        AlertService.ShowError("Login Failed", $"{result.Message}. Please try again.");
                    }
                }
                else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
                {
                    if (result != null && result.StatusCode == 0 && result.Status == false)
                    {
                        AlertService.ShowError($"Login Error", $"{result.Message}. Please try again.");
                        Console.WriteLine($"Unexpected response: {response.StatusCode}");

                    }
                }
            }
           

        }
        catch (Exception ex)
        {
            // AlertService.ShowError("Login Error", "An error occurred during login. Please try again.");
            AlertService.ShowError("Login Error", $"An error occurred during login. {ex.Message}");
            Console.WriteLine($"Login error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Login process

    public class LoginModel
    {
        [Required(ErrorMessage = "Username is required")]
        [MinLength(3, ErrorMessage = "Username must be at least 3 characters")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; }
    }


}

<style>

    .login-form {
        display: flex;
        flex-direction: column;
        gap: 28px;
    }

    .form-field {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .field-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        font-weight: 600;
        color: #cccccc;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

        .field-label svg {
            width: 18px;
            height: 18px;
            color: #953e3f;
        }

    .input-wrapper {
        position: relative;
    }

    .field-input {
        width: 100%;
        padding: 16px 20px;
        background: rgba(0, 0, 0, 0.4);
        border: 2px solid rgba(100, 98, 100, 0.3);
        border-radius: 12px;
        color: #ffffff;
        font-size: 15px;
        transition: all 0.3s ease;
    }

        .field-input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.5);
            border-color: #953e3f;
        }

        .field-input::placeholder {
            color: #666;
        }

    .input-glow {
        position: absolute;
        inset: -2px;
        border-radius: 12px;
        background: linear-gradient(135deg, #953e3f, #646264);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: -1;
        filter: blur(8px);
    }

    .field-input:focus + .input-glow {
        opacity: 0.4;
    }

    .password-wrapper {
        position: relative;
    }

    .password-toggle {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px;
        color: #646264;
        transition: color 0.3s ease;
    }

        .password-toggle:hover {
            color: #953e3f;
        }

        .password-toggle svg {
            width: 22px;
            height: 22px;
            display: block;
        }

    .field-error {
        color: #ff6b6b;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 4px;
    }

    .form-extras {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        position: relative;
    }

        .checkbox-container input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

    .checkbox-custom {
        width: 22px;
        height: 22px;
        border: 2px solid rgba(100, 98, 100, 0.5);
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        position: relative;
    }

    .checkbox-container input[type="checkbox"]:checked + .checkbox-custom {
        background: #953e3f;
        border-color: #953e3f;
    }

        .checkbox-container input[type="checkbox"]:checked + .checkbox-custom::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 11px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

    .checkbox-label {
        color: #999;
        font-size: 14px;
        user-select: none;
    }


   
</style>