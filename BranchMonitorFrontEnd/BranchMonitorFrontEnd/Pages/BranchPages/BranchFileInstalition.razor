@page "/file-installation-branch"
@using Microsoft.AspNetCore.Components
@using Monitoring.Shared.DTO
@using Monitoring.Shared.Models
@using System.Net.Http.Headers
@using System.Net
@using Microsoft.AspNetCore.SignalR.Client;
@using System.Text.Json
@layout BranchNavbarLayout
@inject IJSRuntime JS
@inject AlertService AlertService
@inject AppSettings Settings
@inject AuthCredential _auth


<div >
    <main class="main-content">
        <div class="transfer-container">
            <!-- Header -->
            <div class="transfer-header">
                <h1>Patch Update</h1>
                <div class="connection-status">
                    <span class="status-indicat"></span>
                    @* <span></span> *@
                </div>
            </div>

            <!-- Dual Panel Layout -->
            <div class="dual-panel col-12">
                <!-- Left Panel - Server Files -->
                <div class="panel col-12">
                   
                    <div class="panel-body">
                        <div class="col-12 p-3">
                            <div class="row">
                                <div class="col-6">
                                    <Dropdown Size="DropdownSize.Large" Class="dropdown-btn">
                                        <DropdownToggleButton Class="text-white">
                                            Select Update Type
                                        </DropdownToggleButton>
                                        <DropdownMenu>

                                            <DropdownItem Type="DropdownItemType.Link">fggf</DropdownItem>
                                            <DropdownItem Type="DropdownItemType.Link">fggf</DropdownItem>
                                            <DropdownItem Type="DropdownItemType.Link">fggf</DropdownItem>
                                            <DropdownItem Type="DropdownItemType.Link">fggf</DropdownItem>

                                        </DropdownMenu>
                                    </Dropdown>
                                </div>
                                <div class="col-6">
                                    <Dropdown Size="DropdownSize.Large" Class="dropdown-btn">
                                        <DropdownToggleButton Class="text-white">
                                            Select Updates
                                        </DropdownToggleButton>
                                        <DropdownMenu>

                                            <DropdownItem Type="DropdownItemType.Link">fggf</DropdownItem>
                                            <DropdownItem Type="DropdownItemType.Link">fggf</DropdownItem>
                                            <DropdownItem Type="DropdownItemType.Link">fggf</DropdownItem>
                                            <DropdownItem Type="DropdownItemType.Link">fggf</DropdownItem>

                                        </DropdownMenu>
                                    </Dropdown>
                                </div>
                                <div class="col-12 mt-2 d-flex justify-content-center align-items-center">
                                    <div class="rounded-3 p-3 text-center col-12"
                                         style="border: 1px solid #3e3e3f;">
                                        <div class="row mt-2" >
                                            <div class="col-7" >
                                                <div class="row ">

                                                <div class="col-8 d-flex justify-content-center">
                                                    <div class="col-11 p-2 rounded-4 text-white" style=" border: 1px solid #3e3e3f; background: linear-gradient(135deg, #3e3e3f 0%, #2f2f30 100%); ">
                                                       <div class="col-12 p-2">
                                                                <svg width="50px" height="50px"  viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                    <path d="M13 3H7C5.89543 3 5 3.89543 5 5V10M13 3L19 9M13 3V8C13 8.55228 13.4477 9 14 9H19M19 9V19C19 20.1046 18.1046 21 17 21H10C7.79086 21 6 19.2091 6 17V17C6 14.7909 7.79086 13 10 13H13M13 13L10 10M13 13L10 16" stroke="rgba(76, 175, 80, 0.7)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                                </svg>
                                                            </div>

                                                            <div class="col-12 gap-0">
                                                                <span class="fs-3">1.0.0.0</span> <br>
                                                                <span style="font-size:12px;">(Version)</span>
                                                            </div>
                                                            <div class="col-12 mt-5 gap-3 d-grid ps-3 pe-2">

                                                                <div class="col-12 d-flex  gap-0">
                                                                    <div class="row col-12">
                                                                        <div class="col-4 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50 ">Patch Type</span>
                                                                        </div>
                                                                        <div class="col-1 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50 ">:</span>
                                                                        </div>
                                                                        <div class="col-7 gap-0 text-start">
                                                                            <span style="font-size:14px;" class="text-white-50">Application Update</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="col-12 d-flex  gap-0">
                                                                    <div class="row col-12">
                                                                        <div class="col-4 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50">Patch Name</span>
                                                                        </div>
                                                                        <div class="col-1 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50 ">:</span>
                                                                        </div>
                                                                        <div class="col-7 gap-0 text-start">
                                                                            <span style="font-size:14px;" class="text-white-50">1.0.0.0_20251217_A</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-12 d-flex  gap-0">
                                                                    <div class="row col-12">
                                                                        <div class="col-4 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50">ZIp File</span>
                                                                        </div>
                                                                        <div class="col-1 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50 ">:</span>
                                                                        </div>
                                                                        <div class="col-7 gap-0 text-start">
                                                                            <span style="font-size:14px;" class="text-white-50">1.0.0.0_20251217_A.Zip</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="col-12 d-flex  gap-0">
                                                                    <div class="row col-12">
                                                                        <div class="col-4 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50">Date</span>
                                                                        </div>
                                                                        <div class="col-1 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50 ">:</span>
                                                                        </div>
                                                                        <div class="col-7 gap-0 text-start">
                                                                            <span style="font-size:14px;" class="text-white-50">2025-12-17</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="col-12 d-flex  gap-0">
                                                                    <div class="row col-12">
                                                                        <div class="col-4 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50">Status</span>
                                                                        </div>
                                                                        <div class="col-1 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50 ">:</span>
                                                                        </div>
                                                                        <div class="col-7 gap-0 text-start">
                                                                            <span style="font-size:14px;" class="text-success">Ready</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="col-12 d-flex  gap-0">
                                                                    <div class="row col-12">
                                                                        <div class="col-4 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50">Remark</span>
                                                                        </div>
                                                                        <div class="col-1 gap-0 text-start">
                                                                            <span class="fs-6 text-white-50 ">:</span>
                                                                        </div>
                                                                        <div class="col-7 gap-0 text-start">
                                                                            <span style="font-size:14px;" class="text-white-50">
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                lorem
                                                                                
                                                                            </span>

                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                         
                                                    </div>

                                                </div>

                                                <div class="col-4 ">
                                                    <div>
                                                            
                                                            <button class="btn-upload w-100 mt-3" style="background: linear-gradient(135deg, #953e3f 0%, #b04e4f 100%);" @onclick="() => UploadAsync_Get()">
                                                                Push Branch
                                                            </button>
                                                    </div>
                                                        <div class="mt-5 " style=" border: 1px solid #3e3e3f; background: linear-gradient(135deg, #3e3e3f 0%, #2f2f30 100%); ">

                                                        <div class=" p-2  mb-3" >
                                                            <span class="text-white">Branch</span>

                                                            <div>

                                                            <button class="btn-upload w-100 mt-3" style="background: linear-gradient(135deg, #0f5132 0%, #198754 100%);">
                                                                    Check Update Available
                                                                </button>
                                                            </div> 
                                                        </div>

                                                        <div class=" p-2 mt-5 mb-3" >
                                                            <span class="text-white">Branch</span>
                                                           <div>
                                                            <button class="btn-upload w-100 mt-3" style="background: linear-gradient(135deg, #0f5132 0%, #198754 100%);">
                                                                Install New Update 
                                                            </button>
                                                            </div>

                                                            <div>

                                                                <button class="btn-upload w-100 mt-3" style="background: linear-gradient(135deg, #953e3f 0%, #b04e4f 100%);">
                                                                    Cancel
                                                                </button>
                                                            </div>
                                                            </div>
                                                        </div>
                                                       
                                                </div>
                                            </div>
                                            </div>
                                            <div class="col-5 " >
                                                <div class="col-12 p-2 d-flex justify-content-center">
                                                    <div class="col-12 bg-black opacity-75 rounded-2 p-2 ps-4 pe-4 " style=" border: 1px solid #3e3e3f; height:60vh">
                                                        <div class="uploaded-file " style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3);">

                                                            <svg width="80px" height="80px" style="color: rgba(76, 175, 80, 0.5);" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M22 11.1V6.9C22 3.4 20.6 2 17.1 2H12.9C9.4 2 8 3.4 8 6.9V8H11.1C14.6 8 16 9.4 16 12.9V16H17.1C20.6 16 22 14.6 22 11.1Z" stroke="rgba(76, 175, 80, 0.5)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                                                <path d="M16 17.1V12.9C16 9.4 14.6 8 11.1 8H6.9C3.4 8 2 9.4 2 12.9V17.1C2 20.6 3.4 22 6.9 22H11.1C14.6 22 16 20.6 16 17.1Z" stroke="rgba(76, 175, 80, 0.5)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                                                <path d="M6.08008 15L8.03008 16.95L11.9201 13.05" stroke="rgba(76, 175, 80, 0.5)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                                            </svg>

                                                            <div class="file-info-upload overflow-hidden">
                                                                <span class="file-name-upload ">dsgf</span>
                                                                <span class="file-size-upload">Patch Deployment Server Successfully</span>
                                                            </div>

                                                            <div class="div-status p-1" style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3);">
                                                                <span class="text-success ">Success</span>

                                                            </div>

                                                        </div>

                                                        <div class="uploaded-file  " style="background: rgba(255, 152, 0, 0.1); border: 1px solid rgba(255, 152, 0, 0.3);">

                                                            <svg width="80px" height="80px" viewBox="0 0 24 24" style="color: rgba(255, 152, 0, 0.5);" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M10.25 4.00003C10.25 3.69074 10.0602 3.41317 9.77191 3.30105C9.48366 3.18892 9.15614 3.26524 8.94715 3.49324L3.44715 9.49324C3.24617 9.71248 3.19374 10.0298 3.3135 10.302C3.43327 10.5743 3.70259 10.75 4.00002 10.75H20C20.4142 10.75 20.75 10.4142 20.75 10C20.75 9.58582 20.4142 9.25003 20 9.25003L10.25 9.25003V4.00003Z" fill="rgba(255, 152, 0, 0.5)" />
                                                                <path d="M13.75 20L13.75 14.75H4.00002C3.5858 14.75 3.25002 14.4142 3.25002 14C3.25002 13.5858 3.5858 13.25 4.00002 13.25L20 13.25C20.2974 13.25 20.5668 13.4258 20.6865 13.698C20.8063 13.9703 20.7539 14.2876 20.5529 14.5068L15.0529 20.5068C14.8439 20.7348 14.5164 20.8111 14.2281 20.699C13.9399 20.5869 13.75 20.3093 13.75 20Z" fill="rgba(255, 152, 0, 0.5)" />
                                                            </svg>

                                                            <div class="file-info-upload overflow-hidden">
                                                                <span class="file-name-upload ">dgh</span>
                                                                <span class="file-size-upload">Patch Deployment InProcessing</span>
                                                            </div>

                                                            <Spinner Color="SpinnerColor.Secondary" Size="SpinnerSize.Medium" />
                                                        </div>


                                                        <div class="uploaded-file  " style="background: rgba(82, 132, 250, 0.1); border: 1px solid rgba(82, 132, 250, 0.3);">

                                                            <svg width="80px" height="80px" viewBox="0 0 24 24" style="color: rgba(82, 132, 250, 0.5);" xmlns="http://www.w3.org/2000/svg">
                                                                <path d="M10.25 4.00003C10.25 3.69074 10.0602 3.41317 9.77191 3.30105C9.48366 3.18892 9.15614 3.26524 8.94715 3.49324L3.44715 9.49324C3.24617 9.71248 3.19374 10.0298 3.3135 10.302C3.43327 10.5743 3.70259 10.75 4.00002 10.75H20C20.4142 10.75 20.75 10.4142 20.75 10C20.75 9.58582 20.4142 9.25003 20 9.25003L10.25 9.25003V4.00003Z" fill="rgba(255, 152, 0, 0.5)" />
                                                                <path d="M13.75 20L13.75 14.75H4.00002C3.5858 14.75 3.25002 14.4142 3.25002 14C3.25002 13.5858 3.5858 13.25 4.00002 13.25L20 13.25C20.2974 13.25 20.5668 13.4258 20.6865 13.698C20.8063 13.9703 20.7539 14.2876 20.5529 14.5068L15.0529 20.5068C14.8439 20.7348 14.5164 20.8111 14.2281 20.699C13.9399 20.5869 13.75 20.3093 13.75 20Z" fill="rgba(255, 152, 0, 0.5)" />
                                                            </svg>

                                                            <div class="file-info-upload overflow-hidden">
                                                                <span class="file-name-upload ">fgdf</span>
                                                                <span class="file-size-upload">Converting to Zip</span>
                                                            </div>

                                                            <Spinner Color="SpinnerColor.Secondary" Size="SpinnerSize.Medium" />
                                                        </div>

                                                        <div class="uploaded-file  " style="background: rgba(149, 62, 63, 0.1); border: 1px solid rgba(149, 62, 63, 0.3);">




                                                            <svg width="80px" height="80px" viewBox="0 0 24 24" fill="none">
                                                                <path d="M12 16H12.01M12 8V12M12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21Z" stroke="#953e3f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                            </svg>
                                                            <div class="file-info-upload overflow-hidden">
                                                                <span class="file-name-upload ">fghfg</span>
                                                                <span class="file-size-upload">Patch Deployment Failure</span>
                                                            </div>

                                                            <div class="div-status p-1" style="background: rgba(149, 62, 63, 0.2); border: 1px solid rgba(149, 62, 63, 0.3);">
                                                                <span class="text-danger ">
                                                                    Retry
                                                                </span>

                                                            </div>

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                       
                    </div>

                </div>

                <!-- Transfer Controls -->
             

                <!-- Right Panel - Branch Files -->
               
            </div>

           
        </div>
    </main>
</div>
<AlertContainer />

@code{

    private async Task<string?> GetJwtToken()
    {
        try
        {
            var getJWT = new getJWTTokens(JS);
            return await getJWT.GetJWTLoggedInBranchAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JWT Error: {ex.Message}");
            return null;
        }
    }

    private async Task<LoggedInUser> getUserDetails()
    {
        return await _auth.getLogginUserDetiles();
    }
    private async Task<LogInBranchDeties> getBranchDetails()
    {
        return await _auth.getLogginBranchDetiles();
    }
    public class PatchDeployRequest
    {
        public int PatchId { get; set; }
        public string BranchId { get; set; } // null = all branches
    }
    private async Task UploadAsync_Get()
    {
        try
        {
            var token = await GetJwtToken();

            var patchId = Guid.NewGuid();      // for testing
            var branchId = "BRANCH003";        // optional

            using var client = new HttpClient { BaseAddress = new Uri(Settings.MainApiBaseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);

            // Build query string
            var url = $"api/Patches/deploy?patchId={patchId}&branchId={branchId}";

            var response = await client.GetAsync(url);

            APIResponseObjectValue<object>? result = null;

            if (response.Content.Headers.ContentLength > 0)
            {
                var options = new System.Text.Json.JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                };

                result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<object>>(options);
            }

            if (result != null)
            {
                if (result.Status)
                {
                    Console.WriteLine("SUCCESS: Patch deployment initiated (GET)");
                    Console.WriteLine($"Message: {result.Message}");
                    Console.WriteLine($"Payload: {System.Text.Json.JsonSerializer.Serialize(result.Value)}");
                }
                else
                {
                    Console.WriteLine($"FAILED: {result.Message}");
                }
            }
            else
            {
                Console.WriteLine("No content returned from API");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex}");
            AlertService.ShowError("Client Error", ex.Message);
        }
    }



}

<style>

    .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #3e3e3f;
        border-radius: 6px;
        color: white;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

        .dropdown-btn:hover {
            background: rgba(149, 62, 63, 0.2);
            border-color: #953e3f;
            color: white;
        }

        .dropdown-btn svg {
            color: #999;
            transition: transform 0.3s ease;
        }

        .dropdown-btn:hover svg {
            color: #953e3f;
        }

    .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        min-width: 240px;
        background: #2a2a2b;
        border: 1px solid #3e3e3f;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow: hidden;
        animation: dropdownSlide 0.2s ease;
    }

    @@keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(35px);
        }
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        color: #ffffff;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid #3e3e3f;
    }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(149, 62, 63, 0.2);
        }

        .dropdown-item.active {
            background: rgba(149, 62, 63, 0.3);
        }

            .dropdown-item.active .item-title {
                color: #953e3f;
            }

        .dropdown-item > svg {
            color: #666;
            flex-shrink: 0;
        }

        .dropdown-item.active > svg {
            color: #953e3f;
        }

    .dropdown-item-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }


    .uploaded-file {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 20px;
        padding: 16px;
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        /* background: rgba(149, 62, 63, 0.1);
            border: 1px solid rgba(149, 62, 63, 0.3); */
        border-radius: 10px;
    }

        .uploaded-file svg {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

    .file-info-upload {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .file-name-upload {
        font-size: 14px;
        color: #ffffff;
        font-weight: 600;
    }

    .file-size-upload {
        font-size: 12px;
        color: #666;
    }

    .btn-remove {
        width: 32px;
        height: 32px;
        background: rgba(149, 62, 63, 0.2);
        border: 1px solid rgba(149, 62, 63, 0.3);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .div-status {
        font-size: 14px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }


    .btn-remove:hover {
        background: rgba(149, 62, 63, 0.3);
        transform: rotate(90deg);
    }

    .btn-remove svg {
        width: 16px;
        height: 16px;
        color: #953e3f;
    }


</style>