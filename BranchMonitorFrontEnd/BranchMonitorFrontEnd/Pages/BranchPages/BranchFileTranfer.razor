@page "/sftp-transfer-branch"
@using Microsoft.AspNetCore.Components
@using Monitoring.Shared.DTO
@using Monitoring.Shared.Models
@using System.Net.Http.Headers
@using System.Net
@using Microsoft.AspNetCore.SignalR.Client;
@using System.Text.Json
@layout BranchNavbarLayout
@inject IJSRuntime JS
@inject AlertService AlertService
@inject AppSettings Settings
@inject AuthCredential _auth


<div >
    <main class="main-content">
        <div class="transfer-container">
            <!-- Header -->
            <div class="transfer-header">
                <h1>SFTP File Transfer</h1>
                <div class="connection-status">
                    <span class="status-indicator @(isConnected ? "connected" : "disconnected")"></span>
                    <span>@(isConnected ? "Connected" : "Disconnected")</span>
                </div>
            </div>

            <!-- Dual Panel Layout -->
            <div class="dual-panel">
                <!-- Left Panel - Server Files -->
                <div class="panel server-panel">
                    <div class="panel-header">
                        <div class="header-content">
                            <div class="icon-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                                    <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                                    <line x1="6" y1="6" x2="6.01" y2="6"></line>
                                    <line x1="6" y1="18" x2="6.01" y2="18"></line>
                                </svg>
                                <h2>SFTP Server</h2>
                                <Dropdown  Size="DropdownSize.Small"   Class="dropdown-btn">
                                    <DropdownToggleButton Class="text-white">@SelectedRoot</DropdownToggleButton>
                                        <DropdownMenu>
                                        <DropdownItem @onclick='() => OnSelect("Branch Folder", true)' Type="DropdownItemType.Link" Active="@IsActiveDropdown(true)"> Branch Folder </DropdownItem>
                                        <DropdownItem @onclick='() => OnSelect("All Branch Folder", false)' Type="DropdownItemType.Link" Active="@IsActiveDropdown(false)">All Branch Folder</DropdownItem>
                                        </DropdownMenu>
                                    </Dropdown>
                            </div>
                            <div class="breadcrumb">
                                @if (serverFolder !=null )
                                {
                                    <span>@serverFolder.FullPath.ToString()</span>
                                    
                                }
                            </div>
                        </div>
                        <div class="panel-actions">
                            <button class="action-btn" @onclick="RefreshServer" title="Refresh">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                            </button>
                            <button class="action-btn" @onclick="() => CreateFolder(true)" title="New Folder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                    <line x1="12" y1="11" x2="12" y2="17"></line>
                                    <line x1="9" y1="14" x2="15" y2="14"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        @if (serverFolder != null)
                        {
                           

                            <div class="file-tree">
                                 @RenderFolderTree(serverFolder, true) 

                            </div> 
                        }
                        else
                        {
                            <div style="height:40vh" class="d-flex justify-content-center align-items-center">
                                <Loder Height="50px" width="50px" />
                            </div>

                        }
                       
                    </div>
                    <div class="panel-footer">
                        <span class="item-count">@GetItemCount(serverFolder) items</span>
                        <span class="storage-info">Storage: 2.3GB / 10GB</span>
                    </div>
                </div>

                <!-- Transfer Controls -->
                <div class="transfer-controls">
                    <button class="transfer-btn to-branch"
                            @onclick="TransferToBranch"
                            disabled="@(!HasServerSelection())"
                            title="Transfer to Branch">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                    </button>
                    <div class="transfer-info">
                        <span>@selectedCount selected</span>
                    </div>
                    <button class="transfer-btn to-server"
                            @onclick="TransferToServer"
                            disabled="@(!HasBranchSelection())"
                            title="Transfer to Server">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                    </button>
                </div>

                <!-- Right Panel - Branch Files -->
                <div class="panel branch-panel">
                    <div class="panel-header">
                        <div class="header-content">
                            <div class="icon-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                </svg>
                                <h2>Branch Location</h2>
                                <span style="margin-left: 12px; padding: 6px 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid #3e3e3f; border-radius: 6px; color: #ffffff; font-size: 13px;">Branch @selectedBranchId</span>
                            </div>

                            <div class="breadcrumb">
                                @if (branchFolder != null)
                                {
                                    <span>@branchFolder.FullPath.ToString()</span>

                                }
                            </div>
                        </div>
                        <div class="panel-actions">
                            <button class="action-btn" @onclick="RefreshBranch" title="Refresh">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                            </button>
                            <button class="action-btn" @onclick="() => CreateFolder(false)" title="New Folder">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                    <line x1="12" y1="11" x2="12" y2="17"></line>
                                    <line x1="9" y1="14" x2="15" y2="14"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="file-tree">
                            @if (branchFolder != null)
                            {


                                <div class="file-tree">
                                    @RenderFolderTree(branchFolder, false)

                                </div>
                            }
                            else
                            {
                                <div style="height:40vh" class="d-flex justify-content-center align-items-center">
                                    <Loder Height="50px" width="50px" />
                                </div>

                            }
                           
                        </div>
                    </div>
                    <div class="panel-footer">
                        <span class="item-count">@GetItemCount(branchFolder) items</span>
                        <span class="storage-info">Storage: 1.8GB / 5GB</span>
                    </div>
                </div>
            </div>

            <!-- Transfer Progress -->
            @if (isTransferring)
            {
                <div class="transfer-progress-overlay">
                    <div class="progress-card">
                        <div class="progress-header">
                            <h3>Transferring Files</h3>
                            <button class="close-btn" @onclick="() => isTransferring = false">×</button>
                        </div>
                        <div class="progress-body">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: @transferProgress%"></div>
                            </div>
                            <div class="progress-text">
                                <span>@currentTransferFile</span>
                                <span>@transferProgress%</span>
                            </div>
                            <div class="transfer-stats">
                                <span>Speed: @transferSpeed MB/s</span>
                                <span>Time remaining: @timeRemaining</span>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </main>
</div>
<AlertContainer />


@code {
    private bool isConnected = true;
    private string selectedBranchId = "001";
    private int selectedCount = 0;
    private bool isTransferring = false;
    private double? transferProgress = 0;
    private string currentTransferFile = "";
    private double transferSpeed = 0;
    private string timeRemaining = "00:00";

    // DropDown
    private string SelectedRoot = "Select Root" ;


    // Dropdown state - Only Server Dropdown
    private bool showServerDropdown = false;

    // Server type selection (Branch-specific or Global)
    private string selectedServerType = "Branch Server";
    private string selectedServerTypeKey = "branch";
    private Dictionary<string, string> serverTypes = new()
    {
        { "branch", "Branch Server" },
        { "global", "Global Server" }
    };



    private List<string> serverSelectedFiles = new();
    private List<string> branchSelectedFiles = new();

    private SFTPFolderPath? SFTPFolderPathObj;
    private FolderNode? serverFolder;
    private FolderNode? branchFolder;
    // private FolderNode? FolderNode;

    private  HubConnection _hubConnection;
    private string latestUpdate = "No updates yet";


    private LogInBranchDeties branchId;
    private LoggedInUser user;
    protected override async Task OnInitializedAsync()
    {
        // Build the HubConnection

        // Start connection
        await InilizeSignalR();

        if (await getSFTPFolderPaths())
        {
            if (await getSFTPFolderStructureMain(SFTPFolderPathObj,true))
            {
                if (await getSFTPFolderStructureBranch(SFTPFolderPathObj))
                {
                    // LoadBranchFolder();
                }

            }

        }
        StateHasChanged();


    }

    private async Task InilizeSignalR()
    {
        try
        {
            user = await getUserDetails();
            branchId = await getBranchDetails();

            // string branchId = "BRANCH001";
            _hubConnection = new HubConnectionBuilder()
         .WithUrl(Settings.MainApiBaseUrl + $"branchHub?branchId={branchId.BranchCode}&userId={user.UserId}") // use your API URL
         // .WithAutomaticReconnect()
         .Build();

            // Register event handler
            _hubConnection.On<string>("BranchUpdate", (data) =>
                 {
                     // var status = JsonSerializer.Deserialize<FolderNode>(data);
                     var status = JsonSerializer.Deserialize<BranchJobResponse<FolderNode>>(data);

                     branchFolder = status.jobRsValue;
                     InvokeAsync(StateHasChanged);
                 });


            // Register event handler
            _hubConnection.On<string>("DownloadFile", async(data) =>
                 {
                     // var status = JsonSerializer.Deserialize<FolderNode>(data);
                     var status = JsonSerializer.Deserialize<BranchJobResponse<JobDownloadResponse>>(data);

                     var JobStatus = status.jobRsValue;

                     if (JobStatus.jobStatus == 1)
                     {
                         await afterDownloadAndUpload();
                         await getSFTPFolderStructureBranch(SFTPFolderPathObj);


                     }else
                     if (JobStatus.jobStatus == 0)
                     {
                         AlertService.ShowInfo("File Transfer", "The selected file has already been downloaded.");



                     }
                 });


            // Register event handler
            _hubConnection.On<string>("DownloadFileProgress", async (data) =>
                 {
                     // var status = JsonSerializer.Deserialize<FolderNode>(data);
                     var status = JsonSerializer.Deserialize<BranchJobResponse<JobDownloadResponse>>(data);

                     var JobStatus = status.jobRsValue;

                     if (JobStatus == null) return;

                     if (JobStatus.jobStatus == 0)
                     {


                         if (!isTransferring)
                             isTransferring = true;

                         await InvokeAsync(() =>
   {
       // Example: actual speed and time calculation
       double progressBytes = JobStatus.jobDownloadedBytes ;
       double totalBytes = JobStatus.jobTotalBytes ;

       DateTime jobEndTime = status.jobEndTime.GetValueOrDefault();
       double elapsedSeconds = (DateTime.Now - jobEndTime).TotalSeconds;

       transferProgress = JobStatus.jobProgress;
       if (elapsedSeconds > 0)
       {
           transferSpeed = Math.Round(progressBytes / (1024 * 1024 * 1024) / elapsedSeconds, 2); // MB/s
           double bytesRemaining = totalBytes - progressBytes;
           double secondsRemaining = bytesRemaining / (progressBytes / elapsedSeconds);
           timeRemaining = TimeSpan.FromSeconds(secondsRemaining).ToString(@"mm\:ss");
       }

       StateHasChanged();
                         });
                     }
                 });

            await _hubConnection.StartAsync();
            // Console.WriteLine("✅ SignalR connected");
            if (_hubConnection?.State == HubConnectionState.Connected)
            {
                isConnected = true;
            }
            else
            {
                isConnected = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR connection failed: {ex.Message}");
        }
    }

    private async Task afterDownloadAndUpload()
    { 
        isTransferring = false;
        transferSpeed = 00;
        transferProgress = 00;
        timeRemaining = null;
        SelectedFile=null;
        SelectedisServer=false;
        SelectedisBranch=true;
        StateHasChanged();
    }

    bool IsActiveDropdownActive=true;
    private async Task OnSelect(string item,bool select)
    {
        SelectedRoot = item;
        IsActiveDropdownActive = select;
        await getSFTPFolderStructureMain(SFTPFolderPathObj, select);
    }
    private bool IsActiveDropdown(bool select)
    {
        return IsActiveDropdownActive == select;
    }


    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.StopAsync();
            await _hubConnection.DisposeAsync();
            Console.WriteLine("❌ SignalR disconnected");
        }
    }
    public event Action<string>? OnBranchUpdate;


    //    private async  Task Get(bool firstRender)
    //    {
    //        if (firstRender)
    //        {
    //            Any JS interop or initialization can go here
    //        }
    //        return await base.OnAfterRenderAsync(firstRender);
    // }

    private async Task<string?> GetJwtToken()
    {
        try
        {
            var getJWT = new getJWTTokens(JS);
            return await getJWT.GetJWTLoggedInBranchAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JWT Error: {ex.Message}");
            return null;
        }
    }

    private async Task<LoggedInUser> getUserDetails()
    {
        return await _auth.getLogginUserDetiles();
    }
    private async Task<LogInBranchDeties> getBranchDetails()
    {
        return await _auth.getLogginBranchDetiles();
    }



    private async Task<bool> getSFTPFolderPaths()
    {
        try
        {
            var token = await GetJwtToken();
            if (token != null)
            {
                var SFTPFolderPathObjRe = await GetSFTPPathsAsync(Settings.MainApiBaseUrl, token);
                if (SFTPFolderPathObjRe != null)
                {
                    SFTPFolderPathObj = SFTPFolderPathObjRe;

                    return true;
                }
                else
                {
                    return false;
                }
            }
            return false;
        }catch (Exception ex)
        {
            Console.WriteLine($"Error fetching SFTP folder paths: {ex.Message}");
            return false;

        }

    }
    // private bool isBranchPaths =false;
    private async Task<bool> getSFTPFolderStructureMain(SFTPFolderPath paths, bool isBranchPaths)
    {
        try
        {
            var token = await GetJwtToken();
            if (token != null)
            {
                FolderNode? SFTPFolderPathObjRe;
                if (isBranchPaths)
                {
                    SFTPFolderPathObjRe = await GetSFTPFolderStructureAsync(Settings.MainApiBaseUrl, token, paths.ServerBranchPath);

                }
                else
                {
                    SFTPFolderPathObjRe = await GetSFTPFolderStructureAsync(Settings.MainApiBaseUrl, token, paths.ServerMainPath);

                }
                if (SFTPFolderPathObjRe != null)
                {
                    serverFolder = SFTPFolderPathObjRe;

                    return true;
                }
                else
                {
                    return false;
                }

            }
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching SFTP folder paths: {ex.Message}");
            return false;

        }

    }

    private async Task<bool> getSFTPFolderStructureBranch(SFTPFolderPath paths)
    {
        try
        {
            var token = await GetJwtToken();
            if (token != null)
            {
                var SFTPFolderPathObjRe = await GetBranchSFTPFolderStructureAsync(Settings.MainApiBaseUrl, token, paths.BranchPath);

                if (SFTPFolderPathObjRe)
                {

                    return true;
                }
                else
                {
                    return false;
                }

            }
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching SFTP folder paths: {ex.Message}");
            return false;

        }

    }
    private async Task<FolderNode?> GetSFTPFolderStructureAsync(string baseUrl, string jwtToken,string path)
    {
        try
        {

            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);
            var response = await client.PostAsJsonAsync("api/SFTPFiles/getSFTPServerStructure", path);

            var result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<FolderNode>>();

            if (response.IsSuccessStatusCode)
            {

                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    return result.Value;

                }
            }
            else
            {
                switch (response.StatusCode)
                {
                    case HttpStatusCode.BadRequest:
                    case HttpStatusCode.NotFound:
                    case HttpStatusCode.Unauthorized:
                        if (result?.StatusCode == 1 && result.Status == false)
                        {
                            AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                            return null;
                        }
                        break;

                    case HttpStatusCode.InternalServerError: // 500

                        if (result?.StatusCode == 0 && result.Status == false)
                        {
                            var serverMsg = result?.Message ?? "Server error occurred.";
                            // var content = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Server 500 response body: {result?.Ex}");
                            AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                            return null;
                        }
                        break;

                }


            }

            return null;

        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return null;
        }

    }
    private async Task<bool> GetBranchSFTPFolderStructureAsync(string baseUrl, string jwtToken, string path)
    {
        try
        {

            if (branchId == null)
                branchId = await getBranchDetails();
            if (user == null)
                user = await getUserDetails();

            var obj = new
            {
                Path = path,
                UserId = user.UserId,
                BranchId = branchId.BranchCode
            };
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);
            var response = await client.PostAsJsonAsync("api/SFTPFiles/getSFTPBranchStructure", obj);

            var result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<FolderNode>>();

            if (response.IsSuccessStatusCode)
            {

                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    // return result.Value;
                    return true;    
                }
            }
            else
            {
                switch (response.StatusCode)
                {
                    case HttpStatusCode.BadRequest:
                    case HttpStatusCode.NotFound:
                    case HttpStatusCode.Unauthorized:
                        if (result?.StatusCode == 1 && result.Status == false)
                        {
                            AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                            return false;
                        }
                        break;

                    case HttpStatusCode.InternalServerError: // 500

                        if (result?.StatusCode == 0 && result.Status == false)
                        {
                            var serverMsg = result?.Message ?? "Server error occurred.";
                            // var content = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Server 500 response body: {result?.Ex}");
                            AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                            return false;
                        }
                        break;

                }


            }

            return false;

        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return false;
        }

    }

    private async Task<SFTPFolderPath?> GetSFTPPathsAsync(string baseUrl, string jwtToken)
    {
        try
        {
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

            var response = await client.GetAsync("api/SFTPFiles/getSFTPFolderPaths");

            var result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<SFTPFolderPath>>();

            if (response.IsSuccessStatusCode)
            {

                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    return result.Value;
                }
            }
            else
            {
                switch (response.StatusCode)
                {
                    case HttpStatusCode.BadRequest:
                    case HttpStatusCode.NotFound:
                    case HttpStatusCode.Unauthorized:
                        if (result?.StatusCode == 1 && result.Status == false)
                        {
                            AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                            return null;
                        }
                        break;

                    case HttpStatusCode.InternalServerError: // 500

                        if (result?.StatusCode == 0 && result.Status == false)
                        {
                            var serverMsg = result?.Message ?? "Server error occurred.";
                            // var content = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Server 500 response body: {result?.Ex}");
                            AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                            return null;
                        }
                        break;

                }


            }
            return null;

        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return null;
        }

    }




    private RenderFragment RenderFolderTree(FolderNode folder, bool isServer)
    {
        return builder =>
        {
            if (folder == null) return;

            var sequence = 0;

            // Render SubFolders
            if (folder.SubFolders != null)
            {
                foreach (var subFolder in folder.SubFolders)
                {
                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", "folder-item");

                    // Folder Header
                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", "folder-header");
                    builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => ToggleFolder(subFolder)));

                    // Expand/Collapse Icon
                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "expand-icon");
                    builder.AddContent(sequence++, subFolder.IsExpanded ? "▼" : "▶");
                    builder.CloseElement();

                    // Folder Icon
                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "folder-icon");
                    builder.AddContent(sequence++, "📁");
                    builder.CloseElement();

                    // Folder Name
                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "folder-name");
                    builder.AddContent(sequence++, subFolder.Name);
                    builder.CloseElement();

                    builder.CloseElement(); // folder-header

                    // Folder Contents (if expanded)
                    if (subFolder.IsExpanded)
                    {
                        builder.OpenElement(sequence++, "div");
                        builder.AddAttribute(sequence++, "class", "folder-contents");

                        // Render Files
                        if (subFolder.Files != null)
                        {
                            foreach (var file in subFolder.Files)
                            {
                                builder.OpenElement(sequence++, "div");
                                builder.AddAttribute(sequence++, "class", $"file-item {(IsFileSelected(file, isServer) ? "selected" : "")}");
                                builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => ToggleFileSelection(file, isServer)));



                                // File Icon
                                builder.OpenElement(sequence++, "span");
                                builder.AddAttribute(sequence++, "class", "file-icon");
                                builder.AddContent(sequence++, GetFileIcon(file.Name));
                                builder.CloseElement();

                                // File Info
                                builder.OpenElement(sequence++, "div");
                                builder.AddAttribute(sequence++, "class", "file-info");

                                builder.OpenElement(sequence++, "span");
                                builder.AddAttribute(sequence++, "class", "file-name");
                                builder.AddContent(sequence++, file.Name);
                                builder.CloseElement();

                                builder.OpenElement(sequence++, "span");
                                builder.AddAttribute(sequence++, "class", "file-meta");
                                builder.AddContent(sequence++, $"{file.SizeFormatted} ");
                                builder.CloseElement();

                                builder.CloseElement(); // file-info

                                // Download Button
                                builder.OpenElement(sequence++, "button");
                                builder.AddAttribute(sequence++, "class", "file-action-btn");
                                builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => DownloadFile(file.Name)));
                                builder.AddAttribute(sequence++, "title", "Download");
                                builder.AddMarkupContent(sequence++, @"<svg xmlns=""http://www.w3.org/2000/svg"" width=""14"" height=""14"" viewBox=""0 0 24 24"" fill=""none"" stroke=""currentColor"" stroke-width=""2"">
                                    <path d=""M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4""></path>
                                    <polyline points=""7 10 12 15 17 10""></polyline>
                                    <line x1=""12"" y1=""15"" x2=""12"" y2=""3""></line>
                                </svg>");
                                builder.CloseElement();

                                builder.CloseElement(); // file-item
                            }
                        }

                        // Recursively render sub-folders
                        builder.AddContent(sequence++, RenderFolderTree(subFolder, isServer));

                        builder.CloseElement(); // folder-contents
                    }

                    builder.CloseElement(); // folder-item
                }
            }

            // Render Files at root level
            if (folder.Files != null && folder == (isServer ? serverFolder : branchFolder))
            {
                foreach (var file in folder.Files)
                {
                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", $"file-item {(IsFileSelected(file, isServer) ? "selected" : "")}");
                    builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => ToggleFileSelection(file, isServer)));



                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "file-icon");
                    builder.AddContent(sequence++, GetFileIcon(file.Name));
                    builder.CloseElement();

                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", "file-info");

                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "file-name");
                    builder.AddContent(sequence++, file.Name);
                    builder.CloseElement();

                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "file-meta");
                    builder.AddContent(sequence++, $"{file.SizeFormatted} ");
                    builder.CloseElement();

                    builder.CloseElement();

                    builder.OpenElement(sequence++, "button");
                    builder.AddAttribute(sequence++, "class", "file-action-btn");
                    builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => DownloadFile(file.Name)));
                    builder.AddAttribute(sequence++, "title", "Download");
                    builder.AddMarkupContent(sequence++, @"<svg xmlns=""http://www.w3.org/2000/svg"" width=""14"" height=""14"" viewBox=""0 0 24 24"" fill=""none"" stroke=""currentColor"" stroke-width=""2"">
                        <path d=""M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4""></path>
                        <polyline points=""7 10 12 15 17 10""></polyline>
                        <line x1=""12"" y1=""15"" x2=""12"" y2=""3""></line>
                    </svg>");
                    builder.CloseElement();

                    builder.CloseElement();
                }
            }
        };
    }

    private string GetFileIcon(string fileName)
    {
        var extension = System.IO.Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".zip" or ".7z" or ".rar" => "📦",
            ".exe" or ".bat" => "⚙️",
            ".txt" => "📝",
            ".pdf" => "📕",
            ".xml" or ".json" => "📋",
            ".xlsx" or ".xls" => "📊",
            _ => "📄"
        };
    }

    private void ToggleFolder(FolderNode folder)
    {
        folder.IsExpanded = !folder.IsExpanded;
    }


    private FileNode? SelectedFile;
    private bool SelectedisServer;
    private bool SelectedisBranch=true;

    private void ToggleFileSelection(FileNode fileName, bool isServer)
    {

        if (SelectedFile == fileName)
            SelectedFile = null;

        else
            SelectedFile = fileName;
        SelectedisServer = isServer;
        SelectedisBranch = isServer;


    }

    private bool IsFileSelected(FileNode fileName, bool isServer)
    {
        return isServer = SelectedFile == fileName;
    }



    private bool HasServerSelection() => SelectedisServer;
    private bool HasBranchSelection() => !SelectedisBranch;

    private int GetItemCount(FolderNode folder)
    {
        if (folder == null) return 0;
        int count = folder.Files?.Count ?? 0;
        if (folder.SubFolders != null)
        {
            foreach (var sub in folder.SubFolders)
            {
                count += GetItemCount(sub);
            }
        }
        return count;
    }

    private void ToggleServerDropdown()
    {
        showServerDropdown = true;
        StateHasChanged();
    }





    private async Task TransferToBranch()
    {
        try{


            if (SelectedisServer)
            {
                if (SelectedFile != null)
                {

                    var token = await GetJwtToken();
                    if (token != null)
                    {
                        if (branchId ==null)
                            branchId = await getBranchDetails();
                        if (user == null)
                            user = await getUserDetails();

                        if (await TransferToServerAsync(Settings.MainApiBaseUrl, SelectedFile, token, branchId.BranchCode, user.UserId))
                        {
                            isTransferring = true;

                        }

                    }
                    // Simulate transfer

                }

            }
            // serverSelectedFiles.Clear();
            // selectedCount = 0;
            // isTransferring = false;

        } catch (Exception ex)
        {

        }



    }

    private async Task TransferToServer()
    {

        try
        {
            isTransferring = true;
            transferProgress = 0;

            if (!SelectedisBranch)
            {
                if (SelectedFile != null)
                {

                    for (int i = 0; i <= 100; i += 10)
                    {
                        transferProgress = i;
                        transferSpeed = 1.8 + (i / 10.0);
                        timeRemaining = $"00:{(100 - i) / 10:D2}";
                        await Task.Delay(300);
                        StateHasChanged();
                    }
                }

            }
            branchSelectedFiles.Clear();
            selectedCount = 0;
            isTransferring = false;
        }
        catch (Exception ex)
        {

        }

    }


    private async Task<bool> TransferToServerAsync(string baseUrl, FileNode node, string jwtToken,string branchCode,string userid)
    {
        try
        {
            var obj = new
            {
                Path = node.FullPath,
                File = node.Name,
                UserId = userid,
                BranchId = branchCode,

            };

            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);
            var response = await client.PostAsJsonAsync("api/SFTPFiles/sendFileToBranch", obj);

            var result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<FolderNode>>();

            if (response.IsSuccessStatusCode)
            {

                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    return true;

                }
            }
            else
            {
                switch (response.StatusCode)
                {
                    case HttpStatusCode.BadRequest:
                    case HttpStatusCode.NotFound:
                    case HttpStatusCode.Unauthorized:
                        if (result?.StatusCode == 1 && result.Status == false)
                        {
                            AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                            return false;
                        }
                        break;

                    case HttpStatusCode.InternalServerError: // 500

                        if (result?.StatusCode == 0 && result.Status == false)
                        {
                            var serverMsg = result?.Message ?? "Server error occurred.";
                            // var content = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Server 500 response body: {result?.Ex}");
                            AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                            return false;
                        }
                        break;

                }


            }

            return false;

        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return false;
        }

    }

    private async Task RefreshServer()
    {
        serverFolder = null;
        if (SFTPFolderPathObj != null)
        {
            await getSFTPFolderStructureMain(SFTPFolderPathObj, IsActiveDropdownActive);

        }

    }
    private void RefreshBranch() { }
    private void CreateFolder(bool isServer) { }
    private void DownloadFile(string fileName) { }

    // public class FolderNode
    // {
    //     public string Name { get; set; }
    //     public bool IsExpanded { get; set; }
    //     public List<FileItem> Files { get; set; }
    //     public List<FolderNode> SubFolders { get; set; }
    // }

    // public class FileItem
    // {
    //     public string Name { get; set; }
    //     public string Size { get; set; }
    //     public DateTime Modified { get; set; }
    // }
}

<style>
    /* Folder Items */
    .folder-item {
        margin-bottom: 8px;
    }

    .folder-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: #2a2a2b;
        border: 1px solid #3e3e3f;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .folder-header:hover {
            background: #2f2f30;
            border-color: #953e3f;
        }

    .expand-icon {
        font-size: 10px;
        color: #999;
        width: 16px;
        text-align: center;
    }

    .folder-icon {
        font-size: 18px;
    }

    .folder-name {
        flex: 1;
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
    }

    .folder-contents {
        margin-left: 24px;
        margin-top: 8px;
        border-left: 1px solid #3e3e3f;
        padding-left: 16px;
    }

    /* File Items */
    .file-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: #1e1e1f;
        border: 1px solid transparent;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 4px;
    }

        .file-item:hover {
            background: #2a2a2b;
            border-color: #3e3e3f;
        }

        .file-item.selected {
            background: rgba(149, 62, 63, 0.15);
            border-color: #953e3f;
        }

    .file-checkbox {
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #953e3f;
    }

    .file-icon {
        font-size: 20px;
    }

    .file-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .file-name {
        font-size: 13px;
        color: #ffffff;
        font-weight: 500;
    }

    .file-meta {
        font-size: 11px;
        color: #666;
    }

    .file-action-btn {
        width: 28px;
        height: 28px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #3e3e3f;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0;
    }

    .file-item:hover .file-action-btn {
        opacity: 1;
    }

    .file-action-btn:hover {
        background: rgba(149, 62, 63, 0.3);
        border-color: #953e3f;
    }

    .file-action-btn svg {
        color: #999;
    }

    /* Dropdown Styles */
    .dropdown-container {
        position: relative;
        margin-left: 12px;
    }

    .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #3e3e3f;
        border-radius: 6px;
        color: white;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

        .dropdown-btn:hover {
            background: rgba(149, 62, 63, 0.2);
            border-color: #953e3f;
            color: white;
        }

        .dropdown-btn svg {
            color: #999;
            transition: transform 0.3s ease;
        }

            .dropdown-btn:hover svg {
                color: #953e3f;
            }

    .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        min-width: 240px;
        background: #2a2a2b;
        border: 1px solid #3e3e3f;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow: hidden;
        animation: dropdownSlide 0.2s ease;
    }

    @@keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(35px);
        }
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        color: #ffffff;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid #3e3e3f;
    }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(149, 62, 63, 0.2);

        }

        .dropdown-item.active {
            background: rgba(149, 62, 63, 0.3);
        }

            .dropdown-item.active .item-title {
                color: #953e3f;
            }

        .dropdown-item > svg {
            color: #666;
            flex-shrink: 0;
        }

            .dropdown-item.active > svg {
                color: #953e3f;
            }

    .dropdown-item-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .item-title {
        font-size: 13px;
        font-weight: 600;
        color: #ffffff;
    }

    .item-subtitle {
        font-size: 11px;
        color: #666;
    }

    .check-icon {
        color: #953e3f;
        flex-shrink: 0;
    }

    /* Panel Footer */
    .panel-footer {
        background: #2a2a2b;
        border-top: 1px solid #3e3e3f;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #666;
    }
</style>