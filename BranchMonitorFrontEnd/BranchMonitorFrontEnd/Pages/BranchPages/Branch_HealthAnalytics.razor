@page "/health"
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.SignalR.Client
@using Monitoring.Shared.DTO
@using System.Net
@using System.Text.Json
@inject NavigationManager Navigation
@layout BranchNavbarLayout
@inject IJSRuntime JS
@inject AlertService AlertService
@inject AppSettings Settings
@inject AuthCredential _auth

<!-- Main Content -->
<main class="main-content">
    <div class="health-analytics-wrapper">
        <div class="analytics-container">
            @if (HealthLiveStatus)
            {
                <!-- Left Sidebar with Metrics -->
                <aside class="metrics-sidebar">
                    <h2 class="sidebar-title">System Health</h2>
                    

                    <!-- CPU Metric -->
                    <div class="metric-card @(cpuUsage > 80 ? "critical" : cpuUsage > 60 ? "warning" : "normal")">
                        <div class="metric-chart-mini">
                            <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                                <polyline points="@GetSparklinePoints(cpuHistory)" />
                            </svg>
                        </div>
                        <div class="metric-info">
                            <h3>CPU</h3>
                            <div class="metric-value">@cpuUsage.ToString("F1")%</div>
                            <div class="metric-detail">@cpuSpeed GHz</div>
                        </div>
                    </div>

                    <!-- Memory Metric -->
                    <div class="metric-card @(memoryUsagePercent > 80 ? "critical" : memoryUsagePercent > 60 ? "warning" : "normal")">
                        <div class="metric-chart-mini">
                            <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                                <polyline points="@GetSparklinePoints(memoryHistory)" />
                            </svg>
                        </div>
                        <div class="metric-info">
                            <h3>Memory</h3>
                            <div class="metric-value">@memoryUsed/@memoryTotal GB</div>
                            <div class="metric-detail">(@memoryUsagePercent.ToString("F0")%)</div>
                        </div>
                    </div>

                    <!-- Disk Metric -->
                    <div class="metric-card normal">
                        <div class="metric-chart-mini">
                            <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                                <polyline points="@GetSparklinePoints(diskHistory)" />
                            </svg>
                        </div>
                        <div class="metric-info">
                            <h3>Disk @diskName</h3>
                            <div class="metric-value">@diskType (@diskSSDType)</div>
                            <div class="metric-detail">@diskUsage%</div>
                        </div>
                    </div>

                    <!-- Network Metric -->
                    <div class="metric-card normal">
                        <div class="metric-chart-mini">
                            <svg viewBox="0 0 100 40" preserveAspectRatio="none">
                                <polyline points="@GetSparklinePoints(networkHistory)" />
                            </svg>
                        </div>
                        <div class="metric-info">
                            <h3>Network</h3>
                            <div class="metric-value">Ethernet</div>
                            <div class="metric-detail">S: @networkSend R: @networkReceive Kbps</div>
                        </div>
                    </div>

                    
                </aside>

                <!-- Main Chart Area -->
                <main class="chart-area">
                    <div class="chart-header">
                        <h1>@selectedMetric</h1>
                        <div class="chart-tabs">
                            <button class="@(selectedMetric == "CPU" ? "active" : "")" @onclick='() => SelectMetric("CPU")'>CPU</button>
                            <button class="@(selectedMetric == "Memory" ? "active" : "")" @onclick='() => SelectMetric("Memory")'>Memory</button>
                            <button class="@(selectedMetric == "Disk" ? "active" : "")" @onclick='() => SelectMetric("Disk")'>Disk</button>
                            <button class="@(selectedMetric == "Network" ? "active" : "")" @onclick='() => SelectMetric("Network")'>Network</button>
                        </div>
                        <div class="system-info-badge">
                            <span>IP Address - @terminalIp</span>
                        </div>
                        
                    </div>

                    <div class="chart-container">
                        <div class="chart-canvas">
                            <svg viewBox="0 0 1000 400" preserveAspectRatio="none" class="main-chart">
                                <defs>
                                    <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                        <stop offset="0%" style="stop-color:@GetChartColor();stop-opacity:0.6" />
                                        <stop offset="100%" style="stop-color:@GetChartColor();stop-opacity:0.1" />
                                    </linearGradient>
                                </defs>

                                <!-- Grid lines -->
                                <line x1="0" y1="100" x2="1000" y2="100" stroke="rgba(255,255,255,0.05)" stroke-width="1" />
                                <line x1="0" y1="200" x2="1000" y2="200" stroke="rgba(255,255,255,0.05)" stroke-width="1" />
                                <line x1="0" y1="300" x2="1000" y2="300" stroke="rgba(255,255,255,0.05)" stroke-width="1" />

                                <!-- Area chart -->
                                <path d="@GetAreaPath()" fill="url(#chartGradient)" />

                                <!-- Line chart -->
                                <polyline points="@GetLinePoints()" fill="none" stroke="@GetChartColor()" stroke-width="2" />
                            </svg>

                            <!-- Y-axis labels -->
                            <div class="y-axis">
                                <span>100%</span>
                                <span>75%</span>
                                <span>50%</span>
                                <span>25%</span>
                                <span>0%</span>
                            </div>
                        </div>

                        <div class="time-label">60 seconds</div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-label">Utilization</div>
                            <div class="stat-value">@GetCurrentValue().ToString("F1")%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">@GetSecondaryLabel()</div>
                            <div class="stat-value">@GetSecondaryValue()</div>
                        </div>

                        <div class="stat-item">
                            <div class="stat-label">@GetTherdLabel()</div>
                            <div class="stat-value">@GetTherdValue()</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">@GetFourthLabel()</div>
                            <div class="stat-value">@GetFourthValue()</div>
                        </div>
                       
                          <div class="stat-item">
                            <div class="stat-label">@GetFivethLabel()</div>
                            <div class="stat-value">@GetFivethValue()</div>
                        </div>
                          <div class="stat-item">
                            <div class="stat-label">@GetSixthLabel()</div>
                            <div class="stat-value">@GetSixthValue()</div>
                        </div>
                      
                    </div>

                  
                </main>
            }
            else
            {
                <div class="vw-100 vh-100 d-flex justify-content-center align-items-center">
                    <Loder Height="100px" width="100px" />
                </div>
            }
        </div>
    </div>
</main>

@code {
    // System Properties
    private System.Threading.Timer? timer;
    private HubConnection _hubConnection;
    private LogInBranchDeties branch;
    private LoggedInUser user;
    private bool HealthLiveStatus = false;
    private Random random = new Random();
    private int maxDataPoints = 60;

    // UI State
    private string selectedMetric = "CPU";
    private string systemName = "Kiosk Monitor System";

    // CPU Data
    private double cpuUsage = 100;
    private double cpuSpeed = 2.44;
    private List<double> cpuHistory = new();

    // Memory Data
    private double memoryUsed = 7.3;
    private double memoryTotal = 7.7;
    private double memoryAvailable = 7.7;
    private string? memoryslots;
    private double memoryUsagePercent => (memoryUsed / memoryTotal) * 100;
    private List<double> memoryHistory = new();

      private string Committed;
        private double CachedGB ;
        private double PagedPoolMB;
        private double NonPagedPoolMB ;
        private int SpeedMHz ;
        private string FormFactor ;
        private string SlotsUsed ;
        private double HardwareReservedMB;
    // Disk Data
    private int diskUsage = 43;
    private List<double> diskHistory = new();
    private string? diskName;
    private string? diskType;
    private string? diskSSDType;
    private double? diskCapacity;
    private double? diskFreeSpace;
    private double? diskUsedGBFor;
    

    // Network Data
    private double networkSend = 0;
    private double networkReceive = 0;
    private List<double> networkHistory = new();
    private string? terminalIp ;
    private string? networkAdpterName;
    private string? terminalIpV6;
    private string? ConnectionType;
    private int? SignalStrength;





    // System Data
    private int processes = 378;
    private int threads = 5437;
    private int handles = 191331;
    private string upTime = "3:13:54:08";
    private int Cores;
    private double BaseSpeedGHz;
    private int Sockets;
    private int LogicalProcessors;
    private bool VirtualizationEnabled ;



    protected override async Task OnInitializedAsync()
    {
        user = await GetUserDetails();
        branch = await GetBranchDetails();

        await InitializeSignalR();

        var token = await GetJwtToken();
        if (token != null)
        {
            await GetHealthPerformance(Settings.MainApiBaseUrl, token, branch.BranchCode);
        }

        InitializeHistoryData();
        StartUpdateTimer();
    }

    private void InitializeHistoryData()
    {
        for (int i = 0; i < maxDataPoints; i++)
        {
            cpuHistory.Add(50 + random.Next(-20, 20));
            memoryHistory.Add(70 + random.Next(-10, 10));
            diskHistory.Add(40 + random.Next(-5, 5));
            networkHistory.Add(20 + random.Next(-10, 10));
        }
    }

    private void StartUpdateTimer()
    {
        timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(StateHasChanged);
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(1));
    }

    private async Task InitializeSignalR()
    {
        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Settings.MainApiBaseUrl + $"branchHub?branchId={branch.BranchCode}&userId={user.UserId}")
                .Build();

            _hubConnection.On<string>("PerformanceUpdate", (data) =>
            {
                var status = JsonSerializer.Deserialize<BranchJobResponse<PerformanceInfo>>(data);
                UpdateMetrics(status);
                InvokeAsync(StateHasChanged);
            });

            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR connection failed: {ex.Message}");
        }
    }

    private async Task<LogInBranchDeties> GetBranchDetails()
    {
        return await _auth.getLogginBranchDetiles();
    }

    private async Task<LoggedInUser> GetUserDetails()
    {
        return await _auth.getLogginUserDetiles();
    }

    private async Task<string?> GetJwtToken()
    {
        try
        {
            var getJWT = new getJWTTokens(JS);
            return await getJWT.GetJWTLoggedInBranchAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JWT Error: {ex.Message}");
            return null;
        }
    }

    private async Task<bool> GetHealthPerformance(string baseUrl, string jwtToken, string branchCode)
    {
        try
        {
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

            var response = await client.PostAsJsonAsync("api/Health/getliveHealth", branchCode);
            var result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<FolderNode>>();

            if (response.IsSuccessStatusCode && result?.StatusCode == 2 && result.Status == true)
            {
                return true;
            }

            HandleErrorResponse(response, result);
            return false;
        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return false;
        }
    }

    private void HandleErrorResponse(HttpResponseMessage response, APIResponseObjectValue<FolderNode> result)
    {
        switch (response.StatusCode)
        {
            case HttpStatusCode.BadRequest:
            case HttpStatusCode.NotFound:
            case HttpStatusCode.Unauthorized:
                if (result?.StatusCode == 1 && result.Status == false)
                {
                    AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                }
                break;

            case HttpStatusCode.InternalServerError:
                if (result?.StatusCode == 0 && result.Status == false)
                {
                    var serverMsg = result?.Message ?? "Server error occurred.";
                    Console.WriteLine($"Server 500 response body: {result?.Ex}");
                    AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                }
                break;
        }
    }
      

    private void UpdateMetrics(BranchJobResponse<PerformanceInfo> response)
    {
        if (response?.jobRsValue == null)
        {
            Console.WriteLine("⚠️ Received null performance data");
            return;
        }

        HealthLiveStatus = true;

        var perf = response.jobRsValue;

        // === CPU ===
        cpuUsage = Math.Round(perf.Cpu.CpuUsagePercent, 1);
        cpuSpeed = 2.44; // You can calculate this from base speed if available
        processes = perf.Cpu.ProcessCount;
        threads = perf.Cpu.ThreadCount;
        handles = perf.Cpu.HandleCount;
        upTime = perf.Cpu.UpTime;
        LogicalProcessors = perf.Cpu.LogicalProcessors;
        VirtualizationEnabled = perf.Cpu.VirtualizationEnabled;

        // === RAM ===
        memoryTotal = perf.Ram.TotalGB;
        memoryUsed = perf.Ram.InUseGB;
        memoryAvailable = perf.Ram.AvailableGB;
        memoryslots = perf.Ram.SlotsUsed;
        Committed= perf.Ram.Committed;

        // memoryUsagePercent is auto-calculated via property

        // === DISK ===
        var diskUsedGB = perf.Disk.CapacityGB - perf.Disk.FreeSpaceGB;
        diskUsage = (int)Math.Round((diskUsedGB / perf.Disk.CapacityGB) * 100);
        diskName = perf.Disk.Name;
        diskType = perf.Disk.DriveType;
        diskSSDType = perf.Disk.SSDType;
        diskCapacity = perf.Disk.CapacityGB;
        diskFreeSpace = perf.Disk.FreeSpaceGB;
        diskUsedGBFor = diskUsedGB;

        // === NETWORK ===
        networkSend = perf.Network.SendKbps;
        networkReceive = perf.Network.ReceiveKbps;
        networkAdpterName = perf.Network.AdapterName;
        terminalIp = perf.Network.IPv4;
        terminalIpV6 = perf.Network.IPv6;
        ConnectionType = perf.Network.ConnectionType;

        // === UPDATE GRAPH HISTORY ===
        AddToHistory(cpuHistory, cpuUsage);
        AddToHistory(memoryHistory, memoryUsagePercent);
        AddToHistory(diskHistory, diskUsage);
        AddToHistory(networkHistory, (networkSend + networkReceive) / 2.0);

        // If you're tracking kiosks separately, update that too
        // AddToHistory(kiosksHistory, (kiosksOnline * 100.0 / totalKiosks));
    }

 
    private void AddToHistory(List<double> history, double value)
    {
        history.Add(value);
        if (history.Count > maxDataPoints)
        {
            history.RemoveAt(0);
        }
    }

    private string GetSparklinePoints(List<double> data)
    {
        if (data.Count == 0) return "";

        var points = new List<string>();
        for (int i = 0; i < data.Count; i++)
        {
            double x = (i / (double)(data.Count - 1)) * 100;
            double y = 40 - (data[i] / 100.0 * 40);
            points.Add($"{x:F1},{y:F1}");
        }
        return string.Join(" ", points);
    }

    private List<double> GetCurrentData()
    {
        return selectedMetric switch
        {
            "CPU" => cpuHistory,
            "Memory" => memoryHistory,
            "Disk" => diskHistory,
            "Network" => networkHistory,
            _ => cpuHistory
        };
    }

    private string GetLinePoints()
    {
        var data = GetCurrentData();
        if (data.Count == 0) return "";

        var points = new List<string>();
        for (int i = 0; i < data.Count; i++)
        {
            double x = (i / (double)(data.Count - 1)) * 1000;
            double y = 400 - (data[i] / 100.0 * 400);
            points.Add($"{x:F1},{y:F1}");
        }
        return string.Join(" ", points);
    }

    private string GetAreaPath()
    {
        var data = GetCurrentData();
        if (data.Count == 0) return "";

        var path = "M 0,400 ";
        for (int i = 0; i < data.Count; i++)
        {
            double x = (i / (double)(data.Count - 1)) * 1000;
            double y = 400 - (data[i] / 100.0 * 400);
            path += $"L {x:F1},{y:F1} ";
        }
        path += "L 1000,400 Z";
        return path;
    }

    private string GetChartColor()
    {
        return selectedMetric switch
        {
            "CPU" => "#2196f3",
            "Memory" => "#2196f3",
            "Disk" => "#4caf50",
            "Network" => "#ff9800",
            "Kiosks" => "#953e3f",
            _ => "#2196f3"
        };
    }

    private double GetCurrentValue()
    {
        return selectedMetric switch
        {
            "CPU" => cpuUsage,
            "Memory" => memoryUsagePercent,
            "Disk" => diskUsage,
            "Network" => (networkSend + networkReceive) / 2.0,
            _ => cpuUsage
        };
    }

    
    private string GetSecondaryLabel()
    {
        return selectedMetric switch
        {
            "CPU" => "Speed",
            "Memory" => "Used",
            "Disk" => "Used",
            "Network" => "Throughput",
           
        };
    }

    private string GetSecondaryValue()
    {
        return selectedMetric switch
        {
            "CPU" => $"{cpuSpeed} GHz",
            "Memory" => $"{(memoryUsed):F1} GB",
            "Disk" => $"{diskUsedGBFor} GB",
            "Network" => $"{networkSend + networkReceive} Kbps",
            _ => $"{cpuSpeed} GHz"
        };
    }

    private string GetTherdLabel()
    {
        return selectedMetric switch
        {
            "CPU" => "Processes",
            "Memory" => "Available",
            "Disk" => "Available",
            "Network" => "Adapter Name",

        };
    }

    private string GetTherdValue()
    {
        return selectedMetric switch
        {
            "CPU" => $"{processes}",
            "Memory" => $"{memoryAvailable} GB",
            "Disk" => $"{diskFreeSpace} GB",
            "Network" => $"{networkAdpterName}",
            
        };
    }

    private string GetFourthLabel()
    {
        return selectedMetric switch
        {
            "CPU" => "Up time",
            "Memory" => "All",
            "Disk" => "Capacity",
            "Network" => "Connection type",

        };
    }

    private string GetFourthValue()
    {
        return selectedMetric switch
        {
            "CPU" => $"{upTime}",
            "Memory" => $"{memoryTotal} GB",
            "Disk" => $"{diskCapacity} GB",
            "Network" => $"{ConnectionType}",
        };
    }


    private string GetFivethLabel()
    {
        return selectedMetric switch
        {
            "CPU" => "Logical process",
            "Memory" => "Committed",
            "Disk" => "Type",
            "Network" => "IPV4 address",

        };
    }

    private string GetFivethValue()
    {
        return selectedMetric switch
        {
            "CPU" => $"{LogicalProcessors}",
            "Memory" => $"{Committed} GB",
            "Disk" => $"{diskType} ({diskSSDType})",
            "Network" => $"{terminalIp}",
        };
    }

    private string GetSixthLabel()
    {
        return selectedMetric switch
        {
            "CPU" => "Virtualization",
            "Memory" => "Slots Used",
            "Disk" => "Disk",
            "Network" => "IPV6 address",

        };
    }

    private string GetSixthValue()
    {
        return selectedMetric switch
        {
            "CPU" => $"{(VirtualizationEnabled ? "Enabled" : "Disabled")}",
            "Memory" => $"{memoryslots} ",
            "Disk" => $"{diskName}",
            "Network" => $"{terminalIpV6}",
        };
    }

    

    private void SelectMetric(string metric)
    {
        selectedMetric = metric;
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}

