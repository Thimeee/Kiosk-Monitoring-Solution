@page "/patchupdate/fileserver"
@using Monitoring.Shared.DTO
@using System.Net.Http.Headers
@using System.Net
@using Monitoring.Shared.Models
@inject NavigationManager Navigation
@layout NavbarLayout
@inject IJSRuntime JSRuntime
@inject AlertService AlertService
@inject AppSettings Settings
@inject AuthCredential _auth


<div class="kiosks-wrapper">
    <main class="kiosks-content">
        <section class="kiosks-section mt-4">
                <div class="patch-content d-flex flex-column">
                    <div class="row">

                    <div class="col-4 parent-panel">
                        <div class="panel server-panel">
                            <div class="panel-header">
                                <div class="header-content">
                                    <div class="icon-title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                                            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                                            <line x1="6" y1="6" x2="6.01" y2="6"></line>
                                            <line x1="6" y1="18" x2="6.01" y2="18"></line>
                                        </svg>
                                        <h2>Patches</h2>
                                       
                                    </div>
                                    <div class="breadcrumb">
                                        @if (serverFolder != null)
                                        {
                                            <span>@serverFolder.FullPath.ToString()</span>

                                        }
                                    </div>
                                </div>
                                <div class="panel-actions">
                                   
                                       

                                    <Tooltip Class="d-inline-block" Title="Server Refresh" role="button">

                                        <button class="action-btn"  title="Refresh">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="23 4 23 10 17 10"></polyline>
                                                <polyline points="1 20 1 14 7 14"></polyline>
                                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                            </svg>
                                        </button>
                                    </Tooltip>

                                </div>
                            </div>
                            <div class="panel-body">
                                @if (serverFolder != null)
                                {


                                    <div class="file-tree">
                                        @RenderFolderTree(serverFolder, true)

                                    </div>
                                }
                                else
                                {
                                    <div style="height:40vh" class="d-flex justify-content-center align-items-center">
                                        <Loder Height="50px" width="50px" />
                                    </div>

                                }

                                

                            </div>
                          
                        </div>
                    </div>

                    <!-- Patch Upload Section -->
                    <div class=" d-flex  col-8 flex-row">
                        <div class="patch-options col-12">
                            <div class="row">
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-6">

                                            <h3 class="mt-5 mb-5 pb-4">Deploy patches to file servers</h3>

                                        </div>
                                        <div class="col-6">

                                            <div class="">
                                                @if (!string.IsNullOrEmpty(uploadedFileName) && !LastPathactive)
                                                {
                                                    <div class="uploaded-file  " style="background: rgba(149, 62, 63, 0.1); border: 1px solid rgba(149, 62, 63, 0.3);">
                                                        <svg xmlns="http://www.w3.org/2000/svg" style="color: #953e3f;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                                            <polyline points="13 2 13 9 20 9"></polyline>
                                                        </svg>

                                                        <div class="file-info-upload overflow-hidden">
                                                            <span class="file-name-upload ">@uploadedFileName</span>
                                                            <span class="file-size-upload">@uploadedFileSize MB</span>
                                                        </div>

                                                        <button class="btn-remove" type="button" @onclick="RemoveFile">
                                                            <svg xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                }
                                                @if (LastPath != null && LastPathactive)
                                                {
                                                    <div class="uploaded-file " style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3);">
                                                        <svg xmlns="http://www.w3.org/2000/svg" style="color: rgba(76, 175, 80, 0.3);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                                            <polyline points="13 2 13 9 20 9"></polyline>
                                                        </svg>

                                                        <div class="file-info-upload overflow-hidden">
                                                            <span class="file-name-upload ">@LastPath.PatchZipName</span>
                                                            <span class="file-size-upload">Last Patch Update</span>
                                                        </div>

                                                       
                                                    </div>
                                                } 
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">

                                    <div class="upload-card d-flex flex-column ">
                                     
                                        <div @ref="dropZoneElement"
                                             class="upload-area @(isDragging ? "dragging" : "")"
                                             @ondragenter="HandleDragEnter"
                                             @ondragleave="HandleDragLeave"
                                             @ondragover:preventDefault>

                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="upload-icon">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="17 8 12 3 7 8"></polyline>
                                                <line x1="12" y1="3" x2="12" y2="15"></line>
                                            </svg>

                                            <h3>Drag & Drop patch file here</h3>
                                            <p>or click to browse</p>

                                            <button class="btn-upload" type="button" @onclick:stopPropagation="true" @onclick="TriggerFileInput">
                                                Choose File
                                            </button>

                                            <span class="file-types">Maximum Size : 5GB</span>
                                        </div>

                                        <InputFile OnChange="HandleFileSelected"
                                                   @ref="inputFile"
                                                   id="fileInput"
                                                   style="display: none;" />


                                   
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="options-grid">

                                        
                                     
                                        <div class="form-group">
                                           
                                            <div class="input-wrapper">
                                                @if(PatchTypeList != null)
                                                {
                                                    <Dropdown Size="DropdownSize.Large" Class="dropdown-btn">
                                                        <DropdownToggleButton Class="text-white">
                                                            @selectedPatchTypeName 
                                                            </DropdownToggleButton>
                                                        <DropdownMenu>
                                                            @foreach (var item in PatchTypeList)
                                                            {
                                                                <DropdownItem Type="DropdownItemType.Link" @onclick="() => OnPatchTypeSelected(item)">@item.PatchTypeName</DropdownItem>
															}
                                                            
                                                        </DropdownMenu>
                                                    </Dropdown>
                                                }
                                              
                                            </div>
                                           
                                        </div>
                                      

                                      
                                        <div class="form-group">
                                            <label for="patch-version" class="text-white">Version *</label>
                                            <div class="input-wrapper">
                                                <input type="text"
                                                       id="patch-version"
                                                       class="field-input text-white"
                                                       @bind="patch_version_input"
                                                       placeholder="e.g., 1.0.0"
                                                       required
                                                       pattern="^\d+\.\d+\.\d+$"
                                                       maxlength="20" />
                                                <div class="input-glow"></div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="patch-description" class="text-white">ReleseNote</label>
                                            <div class="input-wrapper">
                                                <textarea id="patch-description"
                                                          class="field-input text-white"
                                                          @bind="relese_note_input"
                                                          placeholder="Enter patch description"
                                                          rows="3"
                                                          maxlength="500"></textarea>
                                                <div class="input-glow"></div>
                                            </div>
                                        </div>

                                     
                                        <div>
                                            <button class="btn-upload w-100 mt-3" @onclick="() => FileUploadToServer()">
                                                Push Server
                                            </button>
                                        </div>


                                    </div>

                                   
                                </div>
                            </div>
                            
                        </div>
                    </div>




                </div>



                    </div>

                    <!-- Server Stats -->
            @if (isUploading)
            {
                <div class="transfer-progress-overlay" style="width:100%">
                    <div class="progress-card" style="width:30%">
                        <div class="progress-header">
                            <h3>Transferring Files</h3>
                            <button class="close-btn" @onclick="() => isUploading = false">×</button>
                        </div>
                        @if (isZipping)
                        {
                            <div class="progress-body">
                                <div class="w-100 p-2 h-25">
                                    <Loder Height="40px" Width="40px" />
                                </div>
                                <div class="progress-text">
                                    @* <span>Zipping patch</span> *@
                                    <span>Zipping patch</span>
                                </div>
                              
                            </div>
                        }
                        else
                        { 
                            <div class="progress-body">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: @uploadProgress%"></div>
                                </div>
                                <div class="progress-text">
                                    <span>Uploaded</span>
                                    <span>@uploadProgress% </span>
                                </div>

                            </div>
                        }

                    </div>
                </div>

            }
        </section>
    </main>
</div>
<AlertContainer />



@code {


    private string? JWTToken;


    private FolderNode? serverFolder; 
    private SFTPFolderPath? SFTPFolderPathObj;


    private List<PatchType>? PatchTypeList;
    private string? selectedPatchTypeName = "Select Patch Type";
    private int? selectedPatchTypeID;
    private NewPatch? LastPath;
    private bool LastPathactive ;
    private string? relese_note_input;
    private string? patch_version_input;



    private ElementReference dropZoneElement;
    private InputFile? inputFile;

    private bool isDragging = false;
    private string uploadedFileName = string.Empty;
    private string uploadedFileSize = string.Empty;
    private bool isUploading = false;
    private bool isZipping = false;

    private int uploadProgress = 0;
    private IBrowserFile? selectedFile;

    private readonly string[] allowedExtensions = { "*" };
    private const long maxFileSize = 5_000L * 1024L * 1024L; // 5000(5GB) MB


    private const int ChunkSize = 2 * 1024 * 1024; // 10MB per chunk

    protected override async Task OnInitializedAsync()
    {

        JWTToken = await GetJwtToken();

        if (JWTToken != null)
        {
            SFTPFolderPathObj = new SFTPFolderPath
            {
                SFTP_Id = 1,
                Id = 1,
                ServerMainPath = @"C:\Branches\Patches\AllNewPatches",
                ServerBranchPath = @"C:\Branches\BR001\download",
                BranchPath = @"\\server\BR001\sftp",
                ServerStatus = 1
            };

            if (await getSFTPFolderStructureMain(SFTPFolderPathObj, true, JWTToken))
            {
            }
            if(await getPatchesTypeAsync(Settings.MainApiBaseUrl, JWTToken)){

            }

            StateHasChanged();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initializeFileUpload", dropZoneElement, "fileInput");
        }
    }

    private void HandleDragEnter()
    {
        isDragging = true;
    }

    private void HandleDragLeave()
    {
        isDragging = false;
    }

    private async Task TriggerFileInput()
    {
        await JSRuntime.InvokeVoidAsync("triggerFileInput", "fileInput");
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        isDragging = false;
        selectedFile = e.File;

        if (selectedFile == null)
            return;



        // Display file info
        uploadedFileName = selectedFile.Name;
        uploadedFileSize = (selectedFile.Size / (1024.0 * 1024.0)).ToString("F2");
        LastPathactive = false;


        // Automatically start upload
    }




    private RenderFragment RenderFolderTree(FolderNode folder, bool isServer)
    {
        return builder =>
        {
            if (folder == null) return;

            var sequence = 0;

            // Render SubFolders
            if (folder.SubFolders != null)
            {
                foreach (var subFolder in folder.SubFolders)
                {
                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", "folder-item");

                    // Folder Header
                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", "folder-header");
                    builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => ToggleFolder(subFolder)));

                    // Expand/Collapse Icon
                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "expand-icon");
                    builder.AddContent(sequence++, subFolder.IsExpanded ? "▼" : "▶");
                    builder.CloseElement();

                    // Folder Icon
                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "folder-icon");
                    builder.AddContent(sequence++, "📁");
                    builder.CloseElement();

                    // Folder Name
                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "folder-name");
                    builder.AddContent(sequence++, subFolder.Name);
                    builder.CloseElement();

                    builder.CloseElement(); // folder-header

                    // Folder Contents (if expanded)
                    if (subFolder.IsExpanded)
                    {
                        builder.OpenElement(sequence++, "div");
                        builder.AddAttribute(sequence++, "class", "folder-contents");

                        // Render Files
                        if (subFolder.Files != null)
                        {
                            foreach (var file in subFolder.Files)
                            {
                                builder.OpenElement(sequence++, "div");
                                builder.AddAttribute(sequence++, "class", $"file-item {(IsFileSelected(file, isServer) ? "selected" : "")}");
                                builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => ToggleFileSelection(file, isServer)));



                                // File Icon
                                builder.OpenElement(sequence++, "span");
                                builder.AddAttribute(sequence++, "class", "file-icon");
                                builder.AddContent(sequence++, GetFileIcon(file.Name));
                                builder.CloseElement();

                                // File Info
                                builder.OpenElement(sequence++, "div");
                                builder.AddAttribute(sequence++, "class", "file-info");

                                builder.OpenElement(sequence++, "span");
                                builder.AddAttribute(sequence++, "class", "file-name");
                                builder.AddContent(sequence++, file.Name);
                                builder.CloseElement();

                                builder.OpenElement(sequence++, "span");
                                builder.AddAttribute(sequence++, "class", "file-meta");
                                builder.AddContent(sequence++, $"{file.SizeFormatted} ");
                                builder.CloseElement();

                                builder.CloseElement(); // file-info



                                // Delete Button
                                builder.OpenElement(sequence++, "button");
                                builder.AddAttribute(sequence++, "class", "file-action-btn");
                                builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => DeleteFile(file.FullPath, isServer)));
                                builder.AddAttribute(sequence++, "title", "delete");
                                builder.AddMarkupContent(sequence++,
                             @"<svg width=""14"" height=""14"" viewBox=""0 0 24 24"" fill=""none"" xmlns=""http://www.w3.org/2000/svg"">
  <path d=""M6 7V18C6 19.1046 6.89543 20 8 20H16C17.1046 20 18 19.1046 18 18V7M6 7H5M6 7H8M18 7H19M18 7H16M10 11V16M14 11V16M8 7V5C8 3.89543 8.89543 3 10 3H14C15.1046 3 16 3.89543 16 5V7M8 7H16"" stroke=""currentColor"" stroke-width=""2"" stroke-linecap=""round"" stroke-linejoin=""round""/>
</svg>");

                                builder.CloseElement();
                                builder.CloseElement(); // file-item
                            }
                        }

                        // Recursively render sub-folders
                        builder.AddContent(sequence++, RenderFolderTree(subFolder, isServer));

                        builder.CloseElement(); // folder-contents
                    }

                    builder.CloseElement(); // folder-item
                }
            }

            // Render Files at root level
            if (folder.Files != null && folder == (isServer ? serverFolder : null))
            {
                foreach (var file in folder.Files)
                {
                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", $"file-item {(IsFileSelected(file, isServer) ? "selected" : "")}");
                    builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => ToggleFileSelection(file, isServer)));



                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "file-icon");
                    builder.AddContent(sequence++, GetFileIcon(file.Name));
                    builder.CloseElement();

                    builder.OpenElement(sequence++, "div");
                    builder.AddAttribute(sequence++, "class", "file-info");

                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "file-name");
                    builder.AddContent(sequence++, file.Name);
                    builder.CloseElement();

                    builder.OpenElement(sequence++, "span");
                    builder.AddAttribute(sequence++, "class", "file-meta");
                    builder.AddContent(sequence++, $"{file.SizeFormatted} ");
                    builder.CloseElement();

                    builder.CloseElement();



                    // Delete Button
                    builder.OpenElement(sequence++, "button");
                    builder.AddAttribute(sequence++, "class", "file-action-btn");
                    builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => DeleteFile(file.FullPath, isServer)));
                    builder.AddAttribute(sequence++, "title", "delete");
                    builder.AddMarkupContent(sequence++,
                 @"<svg width=""14"" height=""14"" viewBox=""0 0 24 24"" fill=""none"" xmlns=""http://www.w3.org/2000/svg"">
  <path d=""M6 7V18C6 19.1046 6.89543 20 8 20H16C17.1046 20 18 19.1046 18 18V7M6 7H5M6 7H8M18 7H19M18 7H16M10 11V16M14 11V16M8 7V5C8 3.89543 8.89543 3 10 3H14C15.1046 3 16 3.89543 16 5V7M8 7H16"" stroke=""currentColor"" stroke-width=""2"" stroke-linecap=""round"" stroke-linejoin=""round""/>
</svg>");
                    builder.CloseElement();

                    builder.CloseElement();
                }
            }
        };
    }

    private string GetFileIcon(string fileName)
    {
        var extension = System.IO.Path.GetExtension(fileName).ToLower();
        return extension switch
        {
            ".zip" or ".7z" or ".rar" => "📦",
            ".exe" or ".bat" => "⚙️",
            ".txt" => "📝",
            ".pdf" => "📕",
            ".xml" or ".json" => "📋",
            ".xlsx" or ".xls" => "📊",
            _ => "📄"
        };
    }

    private void ToggleFolder(FolderNode folder)
    {
        folder.IsExpanded = !folder.IsExpanded;
    }
    private FileNode? SelectedFile;
    private bool SelectedisServer;
    private bool SelectedisBranch = true;

    private void ToggleFileSelection(FileNode fileName, bool isServer)
    {

        if (SelectedFile == fileName)
        {
            SelectedFile = null;
            SelectedisServer = false;
            SelectedisBranch = true;
        }

        else
        {
            SelectedFile = fileName;
            SelectedisServer = isServer;
            SelectedisBranch = isServer;
        }



    }

    private bool IsFileSelected(FileNode fileName, bool isServer)
    {
        return isServer = SelectedFile == fileName;

    }
    private async Task DeleteFile(string fullpath, bool isServer)
    {

    }

    private async Task<string?> GetJwtToken()
    {
        try
        {
            var getJWT = new getJWTTokens(JSRuntime);
            return await getJWT.GetJWTLoggedInUserAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JWT Error: {ex.Message}");
            return null;
        }
    }





    private async Task<bool> getSFTPFolderStructureMain(SFTPFolderPath paths, bool isBranchPaths, string token)
    {
        try
        {
            if (token != null)
            {
                FolderNode? SFTPFolderPathObjRe;


                SFTPFolderPathObjRe = await GetSFTPFolderStructureAsync(Settings.MainApiBaseUrl, token, paths.ServerMainPath);

                if (SFTPFolderPathObjRe != null)
                {
                    serverFolder = SFTPFolderPathObjRe;

                    return true;
                }
                else
                {
                    return false;
                }

            }
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching SFTP folder paths: {ex.Message}");
            return false;

        }

    }






    private async Task<FolderNode?> GetSFTPFolderStructureAsync(string baseUrl, string jwtToken, string path)
    {
        try
        {

            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);
            var response = await client.PostAsJsonAsync("api/Patches/getPatchesFolderPath", path);

            var result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<FolderNode>>();

            if (response.IsSuccessStatusCode)
            {

                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    return result.Value;

                }
            }
            else
            {
                switch (response.StatusCode)
                {
                    case HttpStatusCode.BadRequest:
                    case HttpStatusCode.NotFound:
                    case HttpStatusCode.Unauthorized:
                        if (result?.StatusCode == 1 && result.Status == false)
                        {
                            AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                            return null;
                        }
                        break;

                    case HttpStatusCode.InternalServerError: // 500

                        if (result?.StatusCode == 0 && result.Status == false)
                        {
                            var serverMsg = result?.Message ?? "Server error occurred.";
                            // var content = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Server 500 response body: {result?.Ex}");
                            AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                            return null;
                        }
                        break;

                }


            }

            return null;

        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return null;
        }

    }










    private async Task<bool> getPatchesTypeAsync(string baseUrl, string jwtToken)
    {
        try
        {

            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

            var response = await client.GetAsync("api/Patches/getPatchesTypes");


            var result = await response.Content.ReadFromJsonAsync<APIResponseCoustomizeList<PatchType,NewPatch>>();

            if (response.IsSuccessStatusCode)
            {

                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    PatchTypeList= result.ValueList;
                    LastPath= result.Value;
                    LastPathactive = true;
                    return true;
                }
            }
            else
            {
                switch (response.StatusCode)
                {
                    case HttpStatusCode.BadRequest:
                    case HttpStatusCode.NotFound:
                    case HttpStatusCode.Unauthorized:
                        if (result?.StatusCode == 1 && result.Status == false)
                        {
                            AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                            return false;
                        }
                        break;

                    case HttpStatusCode.InternalServerError: // 500

                        if (result?.StatusCode == 0 && result.Status == false)
                        {
                            var serverMsg = result?.Message ?? "Server error occurred.";
                            // var content = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Server 500 response body: {result?.Ex}");
                            AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                            return false;
                        }
                        break;

                }


            }

            return false;

        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return false;
        }

    }

    private void OnPatchTypeSelected(PatchType patchType)
    {
        selectedPatchTypeName = patchType.PatchTypeName;
        selectedPatchTypeID = patchType.PTId;

        StateHasChanged();
    }

    private LoggedInUser user;
    private CancellationTokenSource? cts;
    private async Task<LoggedInUser> getUserDetails()
    {
        return await _auth.getLogginUserDetiles();
    }

    private async Task FileUploadToServer()
    {
        if (selectedFile == null)
        {
            AlertService.ShowError("File Uploding", "Please Select To Patch File First ");
            return;
        }

        if (selectedPatchTypeID == null)
        {
            AlertService.ShowError("File Uploding", "Please Select To Patch Type ");
            return;
        }
       
        if (patch_version_input == null)
        {
            AlertService.ShowError("File Uploding", "Please Enter  Patch Version ");
            return;
        }

        


        await UploadFile(relese_note_input, patch_version_input, selectedPatchTypeID, selectedPatchTypeName);

    }

    private async Task UploadFile(string releseNote, string patchversion, int? selectedPatchTypeID, string selectedPatchTypeName)
    {
        // if (selectedFile == null)
        //     return;

        cts = new CancellationTokenSource();

        try
        {
            isUploading = true;
            uploadProgress = 0;

            bool firstChunkStatus = false;
            string? seletedFile = null;

            var totalChunks = (int)Math.Ceiling((double)selectedFile.Size / ChunkSize);

            using var stream = selectedFile.OpenReadStream(maxFileSize);
            var buffer = new byte[ChunkSize];

            if (JWTToken != null)
            {


                if (user == null)
                    user = await getUserDetails();

                string jobUId = $"{user.UserId}_{DateTime.Now:yyyyMMdd_HHmmssfff}_{Guid.NewGuid():N}";

                for (int chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++)
                {

                    if (selectedFile == null)
                    {
                        if (seletedFile != null)
                        {
                            var result2 = await UploadFileToServerCancel(Settings.MainApiBaseUrl, JWTToken, jobUId.ToString(), seletedFile);
                            if (result2)
                            {
                                AlertService.ShowWarning("File Upload", "The file upload was cancelled by the user.");
                                seletedFile = null;
                                isUploading = false;
                                isZipping = false;
                                StateHasChanged();
                                return;

                            }
                        }
                    }

                    // int bytesRead = await stream.ReadAsync(buffer);
                    int bytesRead = await stream.ReadAsync(buffer, 0, ChunkSize);
                    var content = new MultipartFormDataContent();
                    if (chunkIndex == 0)
                    {
                        firstChunkStatus = true;
                        seletedFile = selectedFile.Name;
                    }
                    else
                    {
                        firstChunkStatus = false;

                    }



                    content.Add(new ByteArrayContent(buffer, 0, bytesRead), "chunk", selectedFile.Name);
                    content.Add(new StringContent(selectedFile.Name), "fileName");
                    content.Add(new StringContent(chunkIndex.ToString()), "chunkIndex");
                    content.Add(new StringContent(totalChunks.ToString()), "totalChunks");
                    content.Add(new StringContent(user.UserId.ToString()), "userId");
                    content.Add(new StringContent("1"), "branchId");
                    content.Add(new StringContent(releseNote.ToString()), "releseNote");
                    content.Add(new StringContent(patchversion.ToString()), "patchversion");
                    content.Add(new StringContent(selectedPatchTypeID.ToString()), "SelectedPatchTypeID");
                    content.Add(new StringContent(selectedPatchTypeName.ToString()), "selectedPatchTypeName");
                    content.Add(new StringContent(jobUId.ToString()), "jobUId");
                    content.Add(new StringContent(firstChunkStatus.ToString()), "firstChunkStatus");

                    var result = await UploadFileToServer(Settings.MainApiBaseUrl, JWTToken, content);

                    if (result == 1)
                    {
                        if (chunkIndex != totalChunks - 2)
                        {
                            int lastReportedPercent = 0;
                            uploadProgress = (int)(((chunkIndex + 1) / (double)totalChunks) * 100);
                            if (uploadProgress - lastReportedPercent >= 1)
                            {
                                lastReportedPercent = uploadProgress;


                            }
                        }
                        else
                        {
                            isZipping = true;

                        }
                        StateHasChanged();


                    }
                    else if (result == 2)
                    {
                        AlertService.ShowSuccess("File Upload", "The file has been successfully uploaded to Main.");
                    }
                    else
                    {
                        isUploading = false;
                        isZipping = false;
                        StateHasChanged();
                    }
                }
            }
        }
        catch (Exception ex)
        {
        }
        finally
        {
            isUploading = false;
            isZipping = false;
            StateHasChanged();
        }


    }

    private async Task<int> UploadFileToServer(string baseUrl, string jwtToken, MultipartFormDataContent content)
    {
        try
        {
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);
            var response = await client.PostAsync("api/Patches/DeployPatchServer", content);

            var result = await response.Content.ReadFromJsonAsync<APIResponseSingleValue>();

            if (response.IsSuccessStatusCode)
            {

                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    if (result.Message == "Chunk")
                    {
                        return 1;



                    }
                    else if (result.Message == "Complete")
                    {
                        return 2;

                    }


                }
            }
            else
            {
                switch (response.StatusCode)
                {
                    case HttpStatusCode.BadRequest:
                    case HttpStatusCode.NotFound:
                    case HttpStatusCode.Unauthorized:
                        if (result?.StatusCode == 1 && result.Status == false)
                        {
                            AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                            return 0;
                        }
                        break;

                    case HttpStatusCode.InternalServerError: // 500

                        if (result?.StatusCode == 0 && result.Status == false)
                        {
                            var serverMsg = result?.Message ?? "Server error occurred.";
                            // var content = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Server 500 response body: {result?.Ex}");
                            AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                            return 0;
                        }
                        break;

                }


            }

            return 0;

        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return 0;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return 0;
        }

    }
    private async Task<bool> UploadFileToServerCancel(string baseUrl, string jwtToken, string jobId, string fileName)
    {
        try
        {
            var obj = new
            {
                JobUId = jobId,
                FileName = fileName

            };
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);
            var response = await client.PostAsJsonAsync("api/SFTPFiles/UploadFileToServerCancel", obj);

            var result = await response.Content.ReadFromJsonAsync<APIResponseSingleValue>();

            if (response.IsSuccessStatusCode)
            {

                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    return true;


                }
            }
            else
            {
                switch (response.StatusCode)
                {
                    case HttpStatusCode.BadRequest:
                    case HttpStatusCode.NotFound:
                    case HttpStatusCode.Unauthorized:
                        if (result?.StatusCode == 1 && result.Status == false)
                        {
                            AlertService.ShowError("File Sharing Error", $"{result.Message}. Please try again.");
                            return false;
                        }
                        break;

                    case HttpStatusCode.InternalServerError: // 500

                        if (result?.StatusCode == 0 && result.Status == false)
                        {
                            var serverMsg = result?.Message ?? "Server error occurred.";
                            Console.WriteLine($"Server 500 response body: {result?.Ex}");
                            AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                            return false;
                        }
                        break;

                }


            }

            return false;

        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return false;
        }

    }

    private void RemoveFile()
    {
        selectedFile = null;
        uploadedFileName = string.Empty;
        uploadedFileSize = string.Empty;
        uploadProgress = 0;
        // statusMessage = string.Empty;
        // statusClass = string.Empty;
        LastPathactive = true;
    }
}

<style>








    .patch-content {
        display: flex;
        flex-direction: column;
        gap: 30px;
    }






    /* Patch Options */
    .patch-options {
        border: 2px solid rgba(100, 98, 100, 0.3);
        border-radius: 16px;
        padding: 30px;
        padding-top: 2px;
    }

        .patch-options h3 {
            font-size: 18px;
            color: #ffffff;
            font-weight: 700;
            margin: 0 0 20px 0;
        }

    .options-grid {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .option-item {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        position: relative;
    }

        .option-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }

    .checkmark {
        width: 22px;
        height: 22px;
        border: 2px solid rgba(100, 98, 100, 0.4);
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        position: relative;
        flex-shrink: 0;
    }

    .option-item input[type="checkbox"]:checked + .checkmark {
        background: #953e3f;
        border-color: #953e3f;
    }

        .option-item input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 11px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

    .option-item span:last-child {
        font-size: 14px;
        color: #999;
    }

    /* new */

    .input-wrapper {
        position: relative;
    }

    .field-input {
        width: 100%;
        padding: 16px 20px;
        background: rgba(0, 0, 0, 0.4);
        border: 2px solid rgba(100, 98, 100, 0.3);
        border-radius: 12px;
        color: #ffffff;
        font-size: 15px;
        transition: all 0.3s ease;
    }

        .field-input:focus {
            outline: none;
            background: rgba(0, 0, 0, 0.5);
            border-color: #953e3f;
        }

        .field-input::placeholder {
            color: #666;
        }

    .input-glow {
        position: absolute;
        inset: -2px;
        border-radius: 12px;
        background: linear-gradient(135deg, #953e3f, #646264);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: -1;
        filter: blur(8px);
    }

    .field-input:focus + .input-glow {
        opacity: 0.4;
    }

    /* new ? */

    .parent-panel {
        display: grid;
        gap: 20px;
        height: calc(100vh - 200px);
    }

    .panel {
        background: #252526;
        border: 1px solid #3e3e3f;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .server-panel {
        border-left: 3px solid #953e3f;
    }



    /* Panel Header */
    .panel-header {
        background: #2a2a2b;
        border-bottom: 1px solid #3e3e3f;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-content {
        flex: 1;
    }

    .icon-title {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

        .icon-title svg {
            color: #999;
        }

        .icon-title h2 {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

    .breadcrumb {
        font-size: 12px;
        color: #666;
        font-family: 'Courier New', monospace;
    }

    .panel-actions {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #3e3e3f;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .action-btn:hover {
            background: rgba(149, 62, 63, 0.2);
            border-color: #953e3f;
        }

        .action-btn svg {
            color: #999;
        }

    /* Panel Body */
    .panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
    }

    .file-tree {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }





    /* Upload Section */
    .upload-card {
        background: linear-gradient(135deg, #3e3e3f 0%, #2f2f30 100%);
        border: 2px solid rgba(100, 98, 100, 0.3);
        border-radius: 16px;
        padding: 5px;
        /* max-width: 800px; */
        margin: 0 auto;
    }



    .upload-area {
        border: 2px dashed rgba(100, 98, 100, 0.4);
        border-radius: 14px;
        padding: 50px 30px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .upload-area:hover,
        .upload-area.dragging {
            border-color: #953e3f;
            background: rgba(149, 62, 63, 0.05);
        }

    .upload-icon {
        width: 60px;
        height: 60px;
        color: #666;
        margin: 0 auto 20px;
        display: block;
    }

    .upload-area h3 {
        font-size: 18px;
        color: #ffffff;
        margin: 0 0 8px 0;
    }

    .upload-area p {
        font-size: 14px;
        color: #666;
        margin: 0 0 20px 0;
    }

    .btn-upload {
        padding: 12px 32px;
        background: linear-gradient(135deg, #953e3f 0%, #b04e4f 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(149, 62, 63, 0.4);
        }

    .file-types {
        display: block;
        margin-top: 16px;
        font-size: 12px;
        color: #666;
    }

    .uploaded-file {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 20px;
        padding: 16px;
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        /* background: rgba(149, 62, 63, 0.1);
        border: 1px solid rgba(149, 62, 63, 0.3); */
        border-radius: 10px;
    }

        .uploaded-file svg {
            width: 32px;
            height: 32px;
            
            flex-shrink: 0;
        }

    .file-info-upload {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .file-name-upload {
        font-size: 14px;
        color: #ffffff;
        font-weight: 600;
    }

    .file-size-upload {
        font-size: 12px;
        color: #666;
    }

    .btn-remove {
        width: 32px;
        height: 32px;
        background: rgba(149, 62, 63, 0.2);
        border: 1px solid rgba(149, 62, 63, 0.3);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .btn-remove:hover {
            background: rgba(149, 62, 63, 0.3);
            transform: rotate(90deg);
        }

        .btn-remove svg {
            width: 16px;
            height: 16px;
            color: #953e3f;
        }

  
</style>

<script>
    window.initializeFileUpload = (dropZone, inputId) => {
        const inputElement = document.getElementById(inputId);

        if (!dropZone || !inputElement) {
            console.error('Drop zone or input element not found');
            return;
        }

        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Handle dropped files
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                inputElement.files = files;
                const event = new Event('change', { bubbles: true });
                inputElement.dispatchEvent(event);
            }
        }, false);

        // Click anywhere in drop zone to open file browser
        dropZone.addEventListener('click', (e) => {
            // Don't trigger if clicking the button itself
            if (e.target.tagName !== 'BUTTON') {
                inputElement.click();
            }
        });
    };

    window.triggerFileInput = (inputId) => {
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.click();
        }
    };
</script>
<style>
    /* Folder Items */
    .folder-item {
        margin-bottom: 8px;
    }

    .folder-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: #2a2a2b;
        border: 1px solid #3e3e3f;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .folder-header:hover {
            background: #2f2f30;
            border-color: #953e3f;
        }

    .expand-icon {
        font-size: 10px;
        color: #999;
        width: 16px;
        text-align: center;
    }

    .folder-icon {
        font-size: 18px;
    }

    .folder-name {
        flex: 1;
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
    }

    .folder-contents {
        margin-left: 24px;
        margin-top: 8px;
        border-left: 1px solid #3e3e3f;
        padding-left: 16px;
    }

    /* File Items */
    .file-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: #1e1e1f;
        border: 1px solid transparent;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 4px;
    }

        .file-item:hover {
            background: #2a2a2b;
            border-color: #3e3e3f;
        }

        .file-item.selected {
            background: rgba(149, 62, 63, 0.15);
            border-color: #953e3f;
        }

    .file-checkbox {
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #953e3f;
    }

    .file-icon {
        font-size: 20px;
    }

    .file-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .file-name {
        font-size: 13px;
        color: #ffffff;
        font-weight: 500;
        max-width: 350px; /* adjust width */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-meta {
        font-size: 11px;
        color: #666;
    }

    .file-action-btn {
        width: 28px;
        height: 28px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #3e3e3f;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0;
    }

    .file-item:hover .file-action-btn {
        opacity: 1;
    }

    .file-action-btn:hover {
        background: rgba(149, 62, 63, 0.3);
        border-color: #953e3f;
    }

    .file-action-btn svg {
        color: #999;
    }

    /* Dropdown Styles */
    .dropdown-container {
        position: relative;
        margin-left: 12px;
    }

    .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #3e3e3f;
        border-radius: 6px;
        color: white;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

        .dropdown-btn:hover {
            background: rgba(149, 62, 63, 0.2);
            border-color: #953e3f;
            color: white;
        }

        .dropdown-btn svg {
            color: #999;
            transition: transform 0.3s ease;
        }

        .dropdown-btn:hover svg {
            color: #953e3f;
        }

    .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        min-width: 240px;
        background: #2a2a2b;
        border: 1px solid #3e3e3f;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow: hidden;
        animation: dropdownSlide 0.2s ease;
    }

    @@keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(35px);
        }
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        color: #ffffff;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid #3e3e3f;
    }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: rgba(149, 62, 63, 0.2);
        }

        .dropdown-item.active {
            background: rgba(149, 62, 63, 0.3);
        }

            .dropdown-item.active .item-title {
                color: #953e3f;
            }

        .dropdown-item > svg {
            color: #666;
            flex-shrink: 0;
        }

        .dropdown-item.active > svg {
            color: #953e3f;
        }

    .dropdown-item-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .item-title {
        font-size: 13px;
        font-weight: 600;
        color: #ffffff;
    }

    .item-subtitle {
        font-size: 11px;
        color: #666;
    }

    .check-icon {
        color: #953e3f;
        flex-shrink: 0;
    }

    /* Panel Footer */
    .panel-footer {
        background: #2a2a2b;
        border-top: 1px solid #3e3e3f;
        padding: 12px 20px;
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #666;
    }


    /* new */

    /* Transfer Progress Overlay */
    .transfer-progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
    }

    to {
        opacity: 1;
    }

    }

    .progress-card {
        background: #252526;
        border: 1px solid #3e3e3f;
        border-radius: 12px;
        /*    width: 500px;*/
        /*    max-width: 90%;*/
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from

    {
        transform: translateY(50px);
        opacity: 0;
    }

    to {
        transform: translateY(0);
        opacity: 1;
    }

    }

    .progress-header {
        background: #2a2a2b;
        border-bottom: 1px solid #3e3e3f;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .progress-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

    .close-btn {
        width: 28px;
        height: 28px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid #3e3e3f;
        border-radius: 4px;
        color: #999;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .close-btn:hover {
            background: rgba(149, 62, 63, 0.3);
            border-color: #953e3f;
            color: #ffffff;
        }

    .progress-body {
        padding: 24px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #1e1e1f;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 16px;
       
    }



    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #953e3f 0%, #b04e4f 100%);
        transition: width 0.3s ease;
        border-radius: 4px;
    }

    .progress-text {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        color: #ffffff;
        margin-bottom: 12px;
    }

    .transfer-stats {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #666;
    }
</style>