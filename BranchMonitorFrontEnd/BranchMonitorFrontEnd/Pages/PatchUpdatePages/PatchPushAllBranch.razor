@page "/patchupdate/patch-update-all-Branch"
@using Microsoft.AspNetCore.SignalR.Client
@using Monitoring.Shared.DTO
@using System.Net.Http.Headers
@using System.Net
@using Monitoring.Shared.DTO.BranchDto
@using Monitoring.Shared.DTO.PatchsDto
@using Monitoring.Shared.Enum
@using Monitoring.Shared.Models
@using static Monitoring.Shared.DTO.PatchsDto.SelectedPatch
@inject NavigationManager Navigation
@layout NavbarLayout
@inject IJSRuntime JSRuntime
@inject AlertService AlertService
@inject AppSettings Settings
@inject AuthCredential _auth
@inject IJSRuntime JS

<div class="deployment-wrapper">
    <main class="deployment-content">
        <section class="deployment-section mt-4">

            <!-- Page Header -->
            

            <div class="deployment-grid">

                <!-- Left Panel - Patch Selection -->
                <div class="patch-selection-panel">
                    <div class="panel-card">
                        <div class="panel-card-header">
                            <div class="header-icon">
                               
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1z" />
                                </svg>
                            </div>
                            <h2>Select Patch</h2>
                        </div>

                        <div class="panel-card-body">
                            <!-- Dropdown Section -->
                            <div class="dropdown-section">
                                <div class="dropdown-group">
                                    <label class="dropdown-label">Patch Type</label>
                                    <Dropdown Size="DropdownSize.None" Class="custom-dropdown" >
                                        <DropdownToggleButton Class="custom-dropdown-btn">
                                            <span class="dropdown-text">@selectedPatchTypeName</span>
                                            <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                            </svg>
                                        </DropdownToggleButton>
                                        <DropdownMenu Class="custom-dropdown-menu">
                                            @if (PatchTypeList != null && PatchTypeList.Any())
                                            {
                                                @foreach (var item in PatchTypeList)
                                                {
                                                    <DropdownItem Type="DropdownItemType.Link" @onclick="() => OnPatchTypeSelected(item)" Class="custom-dropdown-item">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0z" />
                                                        </svg>
                                                        @item.Name
                                                    </DropdownItem>
                                                }
                                            }
                                            else
                                            {
                                                <span class="dropdown-empty">Loading...</span>
                                            }
                                        </DropdownMenu>
                                    </Dropdown>
                                </div>

                                <div class="dropdown-group">
                                    <label class="dropdown-label">Patch Version</label>
                                    <Dropdown Size="DropdownSize.None" Class="custom-dropdown" Disabled="@(SelectedPatchList == null || !SelectedPatchList.Any())">
                                        <DropdownToggleButton Class="custom-dropdown-btn">
                                            <span class="dropdown-text">@selectedPatchName</span>
                                            <svg class="dropdown-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z" />
                                            </svg>
                                        </DropdownToggleButton>
                                        <DropdownMenu Class="custom-dropdown-menu">
                                            @if (SelectedPatchList != null && SelectedPatchList.Any())
                                            {
                                                @foreach (var item in SelectedPatchList)
                                                {
                                                    <DropdownItem Type="DropdownItemType.Link" @onclick="() => OnPatchsSelected(item)" Class="custom-dropdown-item">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                            <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm6.5 4.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3a.5.5 0 0 1 1 0z" />
                                                        </svg>
                                                        @item.Name
                                                    </DropdownItem>
                                                }
                                            }
                                            else
                                            {
                                                <span class="dropdown-empty">Select a type first</span>
                                            }
                                        </DropdownMenu>
                                    </Dropdown>
                                </div>
                            </div>

                            <!-- Patch Details -->
                            <div class="patch-details-section">
                                @if (IsLoadingPatch)
                                {
                                    <div class="details-state loading-state">
                                        <Loder Height="40px" width="40px" />
                                        <span class="state-text">Loading patch details...</span>
                                    </div>
                                }
                                else if (SelectPatch == null)
                                {
                                    <div class="details-state empty-state">
                                        <div class="empty-icon">
                                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                <path d="M13 3H7C5.89543 3 5 3.89543 5 5V10M13 3L19 9M13 3V8C13 8.55228 13.4477 9 14 9H19M19 9V19C19 20.1046 18.1046 21 17 21H10C7.79086 21 6 19.2091 6 17V17C6 14.7909 7.79086 13 10 13H13M13 13L10 10M13 13L10 16" stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </div>
                                        <span class="state-text">Select a patch to view details</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="patch-info-card">
                                        <div class="patch-info-header">
                                            <div class="patch-icon">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M13 3H7C5.89543 3 5 3.89543 5 5V10M13 3L19 9M13 3V8C13 8.55228 13.4477 9 14 9H19M19 9V19C19 20.1046 18.1046 21 17 21H10C7.79086 21 6 19.2091 6 17V17C6 14.7909 7.79086 13 10 13H13M13 13L10 10M13 13L10 16" stroke-linecap="round" stroke-linejoin="round" />
                                                </svg>
                                            </div>
                                            <div class="patch-title-group">
                                                <h3 class="patch-version">@SelectPatch.PatchVersion</h3>
                                                <span class="version-tag">VERSION</span>
                                            </div>
                                        </div>

                                        <div class="patch-info-body">
                                            <div class="info-item">
                                                <div class="info-label">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                        <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z" />
                                                    </svg>
                                                    Patch Type
                                                </div>
                                                <div class="info-value">@SelectPatch.PatchType</div>
                                            </div>

                                            <div class="info-item">
                                                <div class="info-label">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                        <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0z" />
                                                    </svg>
                                                    Patch Name
                                                </div>
                                                <div class="info-value">@SelectPatch.PatchZipName</div>
                                            </div>

                                            <div class="info-item">
                                                <div class="info-label">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                        <path d="M4.406 3.342A5.53 5.53 0 0 1 8 2c2.69 0 4.923 2 5.166 4.579C14.758 6.804 16 8.137 16 9.773 16 11.569 14.502 13 12.687 13H3.781C1.708 13 0 11.366 0 9.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z" />
                                                    </svg>
                                                    File Path
                                                </div>
                                                <div class="info-value path-value">@($"{SelectPatch.PatchZipPath}\\{SelectPatch.PatchZipName}.zip")</div>
                                            </div>

                                            <div class="info-item">
                                                <div class="info-label">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                        <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5z" />
                                                    </svg>
                                                    Date Created
                                                </div>
                                                <div class="info-value">@SelectPatch.CreateDate</div>
                                            </div>

                                            <div class="info-item">
                                                <div class="info-label">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                        <path d="M2.5 1A1.5 1.5 0 0 0 1 2.5v11A1.5 1.5 0 0 0 2.5 15h6.086a1.5 1.5 0 0 0 1.06-.44l4.915-4.914A1.5 1.5 0 0 0 15 8.586V2.5A1.5 1.5 0 0 0 13.5 1h-11z" />
                                                    </svg>
                                                    Remark
                                                </div>
                                                <div class="info-value">@(string.IsNullOrEmpty(SelectPatch.Remark) ? "No remarks" : SelectPatch.Remark)</div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - Branch Selection -->
                <div class="branch-selection-panel">
                    <div class="panel-card">
                        <div class="panel-card-header">
                            <div class="header-left-section">
                                <div class="header-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M4.5 1a.5.5 0 0 0-.5.5V6a.5.5 0 0 0 .5.5h1.5V1H4.5zM10 6.5V1h1.5a.5.5 0 0 1 .5.5V6a.5.5 0 0 1-.5.5H10z" />
                                        <path d="M3 0a1 1 0 0 0-1 1v14a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1H3z" />
                                    </svg>
                                </div>
                                <h2>Select Branches</h2>
                            </div>

                            <div class="header-actions">
                                @if (SelectPatchIf)
                                {
                                    <Dropdown Size="DropdownSize.None" Class="status-filter-dropdown">
                                        <DropdownToggleButton Class="filter-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z" />
                                            </svg>
                                            <span>@SelectedStatusText</span>
                                        </DropdownToggleButton>
                                        <DropdownMenu Class="custom-dropdown-menu">
                                            <DropdownItem @onclick="() => OnStatusSelected(null)" Class="custom-dropdown-item">All Status</DropdownItem>
                                            <DropdownItem @onclick="() => OnStatusSelected(PatchStatus.RESTART)" Class="custom-dropdown-item">Not Enrolled</DropdownItem>
                                            <DropdownItem @onclick="() => OnStatusSelected(PatchStatus.FAILED)" Class="custom-dropdown-item">Failed</DropdownItem>
                                            <DropdownItem @onclick="() => OnStatusSelected(PatchStatus.IN_PROGRESS)" Class="custom-dropdown-item">In Progress</DropdownItem>
                                            <DropdownItem @onclick="() => OnStatusSelected(PatchStatus.INIT)" Class="custom-dropdown-item">Initialize</DropdownItem>
                                            <DropdownItem @onclick="() => OnStatusSelected(PatchStatus.SUCCESS)" Class="custom-dropdown-item">Success</DropdownItem>
                                        </DropdownMenu>
                                    </Dropdown>
                                }

                                <div class="search-box">
                                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                                    </svg>
                                    <input type="text"
                                           class="search-input"
                                           @bind="searchText"
                                           @bind:event="oninput"
                                           @onkeypress="HandleKeyPress"
                                           placeholder="Search branches..." />
                                </div>
                            </div>
                        </div>

                        @if (BranchList != null && BranchList.Any())
                        {
                            <div class="selection-toolbar">
                                <div class="selection-info">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                                    </svg>
                                    <span class="selection-count">@SelectedBranches.Count of @BranchList.Count branch(es) selected</span>
                                </div>

                                <div class="toolbar-actions">
                                    <button @onclick="SelectAllBranches" class="toolbar-btn select-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M12.354 4.354a.5.5 0 0 0-.708-.708L5 10.293 1.854 7.146a.5.5 0 1 0-.708.708l3.5 3.5a.5.5 0 0 0 .708 0l7-7z" />
                                        </svg>
                                        Select All
                                    </button>

                                    <button @onclick="DeselectAllBranches" class="toolbar-btn deselect-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                                        </svg>
                                        Clear
                                    </button>

                                    <button @onclick="DeployToSelectedBranches"
                                            class="toolbar-btn deploy-btn"
                                            disabled="@(IsDeployingToAll || !SelectedBranches.Any() || SelectPatch == null)">
                                        @if (IsDeployingToAll)
                                        {
                                            <Spinner Color="SpinnerColor.Light" Size="SpinnerSize.Small" />
                                            <span>Deploying...</span>
                                        }
                                        else
                                        {
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09z" />
                                            </svg>
                                            <span>Deploy (@SelectedBranches.Count)</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        }

                        <div class="branches-container">
                            @if (IsLoadingBranches)
                            {
                                <div class="branches-state loading-state">
                                    <Loder Height="50px" width="50px" />
                                    <span class="state-text">Loading branches...</span>
                                </div>
                            }
                            else if (BranchList == null || !BranchList.Any())
                            {
                                <div class="branches-state empty-state">
                                    <div class="empty-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                            <path d="M4.285 12.433a.5.5 0 0 0 .683-.183A3.498 3.498 0 0 1 8 10.5c1.295 0 2.426.703 3.032 1.75a.5.5 0 0 0 .866-.5A4.498 4.498 0 0 0 8 9.5a4.5 4.5 0 0 0-3.898 2.25.5.5 0 0 0 .183.683z" />
                                        </svg>
                                    </div>
                                    <span class="state-text">No branches found</span>
                                </div>
                            }
                            else
                            {
                                <div class=" overflow-y-scroll vh-100">
                                    <div class="branches-list">
                                        @RenderAllBranch(BranchList)
                                    </div>
                                </div>
                              
                            }
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<AlertContainer />

@code {
    // [ALL EXISTING CODE REMAINS THE SAME - NO CHANGES]
    // ====== AUTHENTICATION & CONFIG ======
    private string? JWTToken;

    // ====== BRANCH DATA ======
    private List<SelectBranchDtoWithSelectedPatchDto>? BranchList;
    private List<SelectBranchDtoWithSelectedPatchDto> SelectedBranches = new();
    private string searchText = string.Empty;
    private bool IsLoadingBranches = false;
    private bool SelectPatchIf = false;
    private string? selectedStatus;
    private int? patchId;

    // ====== PATCH DATA ======
    private List<SelectedAnyDropDownOrSamllData>? PatchTypeList;
    private List<SelectedAnyDropDownOrSamllData>? SelectedPatchList;
    private string selectedPatchTypeName = "Select Patch Type";
    private string selectedPatchName = "First Select Update Type";
    private SelectedPatch? SelectPatch;

    // ====== UI STATE ======
    private bool IsLoadingPatch { get; set; }
    private bool IsDeployingToAll = false;

    // ====== LIFECYCLE ======
    protected override async Task OnInitializedAsync()
    {
        JWTToken = await GetJwtToken();

        if (JWTToken != null)
        {
            await Task.WhenAll(
                LoadBranchesAsync(),
                getPatchesTypeAsync(Settings.MainApiBaseUrl, JWTToken)
            );
        }
    }

    // ====== BRANCH METHODS ======
    private async Task LoadBranchesAsync()
    {
        IsLoadingBranches = true;
        StateHasChanged();

        try
        {
            if (Settings.MainApiBaseUrl != null && JWTToken != null)
            {
                var branchList = await getAllBranch($"{Settings.MainApiBaseUrl}", JWTToken);
                if (branchList != null)
                {
                    BranchList = branchList;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.Message}");
            AlertService.ShowError("Error", $"Failed to load branches: {ex.Message}");
        }
        finally
        {
            IsLoadingBranches = false;
            StateHasChanged();
        }
    }

    private RenderFragment RenderAllBranch(List<SelectBranchDtoWithSelectedPatchDto> branch)
    {
        return builder =>
        {
            if (branch == null) return;

            var sequence = 0;

            foreach (var selectbranch in branch)
            {
                var isSelected = IsBranchSelected(selectbranch.Id);
                var isOnline = selectbranch.TerminalActiveStatus == TerminalActive.TERMINAL_ONLINE;

                string isPatchstyle = "";

                if (selectbranch.SelectPatchNotEnrollPatchStatus)
                {
                    isPatchstyle = "notenroll";
                }
                else if (selectbranch.EnrollBranch != null)
                {
                    var status = selectbranch.EnrollBranch.Status;

                    switch (status)
                    {
                        case PatchStatus.FAILED:
                            isPatchstyle = "failed";
                            break;

                        case PatchStatus.SUCCESS:
                            isPatchstyle = "success";
                            break;

                        case PatchStatus.IN_PROGRESS:
                            isPatchstyle = "inprogress";
                            break;

                        case PatchStatus.ROLLBACK:
                            isPatchstyle = "rollback";
                            break;

                        case PatchStatus.INIT:
                            isPatchstyle = "init";
                            break;

                        case PatchStatus.RESTART:
                            isPatchstyle = "restart";
                            break;

                        default:
                            isPatchstyle = "deactive";
                            break;
                    }
                }

                // Main card container
                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", $"branch-item {(isSelected ? "selected" : "")} {(!isOnline ? "disabled" : "")}");
                builder.AddAttribute(sequence++, "onclick", EventCallback.Factory.Create(this, () => isOnline ? OnBranchClick(selectbranch) : Task.CompletedTask));

                // Selection checkbox
                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "branch-checkbox");
                if (isOnline)
                {
                    if (isSelected)
                    {
                        builder.AddContent(sequence++, (MarkupString)@"
                            <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='currentColor' viewBox='0 0 16 16'>
                                <path d='M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm10.03 4.97a.75.75 0 0 1 .011 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.75.75 0 0 1 1.079-.022z'/>
                            </svg>
                        ");
                    }
                    else
                    {
                        builder.AddContent(sequence++, (MarkupString)@"
                            <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='currentColor' viewBox='0 0 16 16'>
                                <path d='M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z'/>
                            </svg>
                        ");
                    }
                }
                else
                {
                    builder.AddContent(sequence++, (MarkupString)@"
                        <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='currentColor' viewBox='0 0 16 16'>
                            <path d='M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z'/>
                        </svg>
                    ");
                }
                builder.CloseElement();

                // Branch icon
                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "branch-avatar");
                builder.AddContent(sequence++, (MarkupString)$@"
                    <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='currentColor' viewBox='0 0 16 16'>
                        <path d='M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'/>
                    </svg>
                ");
                builder.CloseElement();

                // Branch info
                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "branch-main-info");

                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "branch-name-row");
                builder.AddContent(sequence++, $"{selectbranch.BranchName}");
                builder.OpenElement(sequence++, "span");
                builder.AddAttribute(sequence++, "class", "branch-id-badge");
                builder.AddContent(sequence++, selectbranch.BranchId);
                builder.CloseElement();
                builder.CloseElement();

                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "branch-terminal");
                builder.AddContent(sequence++, (MarkupString)$@"
                    <svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='currentColor' viewBox='0 0 16 16'>
                        <path d='M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4z'/>
                    </svg>
                    {selectbranch.TerminalId}
                ");
                builder.CloseElement();

                builder.CloseElement();

                // Status badges
                builder.OpenElement(sequence++, "div");
                builder.AddAttribute(sequence++, "class", "branch-status-group");

                builder.OpenElement(sequence++, "span");
                builder.AddAttribute(sequence++, "class", $"connection-badge {(isOnline ? "online" : "offline")}");
                builder.AddContent(sequence++, isOnline ? "●ONLINE" : "●OFFLINE");
                builder.CloseElement();

                builder.OpenElement(sequence++, "span");
                builder.AddAttribute(sequence++, "class", $"patch-status-badge {isPatchstyle}");
                builder.AddContent(sequence++, selectbranch.SelectPatchNotEnrollPatchStatus
                    ? "NOT ENROLLED"
                    : (selectbranch.EnrollBranch?.Status.ToString().ToUpper() ?? "UNKNOWN"));
                builder.CloseElement();

                builder.CloseElement();

                builder.CloseElement(); // Close branch-item
            }
        };
    }

    private async Task OnBranchClick(SelectBranchDtoWithSelectedPatchDto branch)
    {
        if (branch.TerminalActiveStatus != TerminalActive.TERMINAL_ONLINE)
            return;

        if (SelectedBranches.Any(b => b.Id == branch.Id))
        {
            SelectedBranches.RemoveAll(b => b.Id == branch.Id);
        }
        else
        {
            SelectedBranches.Add(branch);
        }
        StateHasChanged();
    }

    private bool IsBranchSelected(int? branchId)
    {
        return SelectedBranches.Any(b => b.Id == branchId);
    }

    private void SelectAllBranches()
    {
        if (BranchList != null)
        {
            SelectedBranches = BranchList
                .Where(b => b.TerminalActiveStatus == TerminalActive.TERMINAL_ONLINE)
                .ToList();
            StateHasChanged();
        }
    }

    private void DeselectAllBranches()
    {
        SelectedBranches.Clear();
        StateHasChanged();
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnSearchAsync();
        }
    }

    private async Task OnSearchAsync()
    {
        DeselectAllBranches();
        await LoadBranchesAsync();
    }

    // ====== PATCH METHODS ======
    private async Task OnPatchTypeSelected(SelectedAnyDropDownOrSamllData patchType)
    {
        selectedPatchTypeName = patchType.Name;
        selectedPatchName = $"Select {patchType.Name}";
        SelectedPatchList = null;
        SelectPatch = null;

        JWTToken ??= await GetJwtToken();

        if (await getSelectedPatchesAsync(Settings.MainApiBaseUrl, JWTToken!, patchType.Id))
        {
            StateHasChanged();
        }
    }

    private async Task OnPatchsSelected(SelectedAnyDropDownOrSamllData patch)
    {
        IsLoadingPatch = true;
        selectedPatchName = patch.Name;

        try
        {
            JWTToken ??= await GetJwtToken();

            if (await getSelectedPatchAllAsync(Settings.MainApiBaseUrl, JWTToken!, patch.Id))
            {
                SelectPatchIf = true;
                patchId = patch.Id;
                await LoadBranchesAsync();
            }
        }
        finally
        {
            IsLoadingPatch = false;
            StateHasChanged();
        }
    }

    // ====== DEPLOYMENT METHODS ======
    private async Task DeployToSelectedBranches()
    {
        if (!SelectedBranches.Any())
        {
            AlertService.ShowWarning("No Branches Selected", "Please select at least one branch.");
            return;
        }

        if (SelectPatch == null)
        {
            AlertService.ShowWarning("No Patch Selected", "Please select a patch first.");
            return;
        }

        // var confirmResult = await JS.InvokeAsync<bool>("confirm",
        //     $"Deploy patch '{SelectPatch.PatchZipName}' to {SelectedBranches.Count} branch(es)?");

        // if (!confirmResult)
        //     return;

        IsDeployingToAll = true;
        StateHasChanged();

        try
        {
            JWTToken ??= await GetJwtToken();
            var user = await getUserDetails();

            var branchIds = SelectedBranches.Select(b => b.Id).ToList();

            var obj = new APIRequestObject<AllBranchPatchRequest>
            {
                ReqValue = new AllBranchPatchRequest
                {
                    PatchId = SelectPatch.PId,
                    BranchIds = branchIds,
                    UserId = user.UserId
                }
            };

            var result = await PatchdeployAllBranches(Settings.MainApiBaseUrl, JWTToken!, obj);

            if (result != null)
            {
                var successMsg = $"Deployment initiated: {result.SuccessfulInitiations}/{result.TotalBranches} branches";
                AlertService.ShowSuccess("Deployment Started", successMsg);

                if (result.FailedInitiations > 0)
                {
                    var failedBranches = result.DeploymentResults
                        .Where(r => r.Status == "Failed")
                        .Select(r => r.BranchName);

                    var failedMsg = $"Failed branches: {string.Join(", ", failedBranches)}";
                    AlertService.ShowWarning("Partial Deployment", failedMsg);
                }

                DeselectAllBranches();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Deploy error: {ex.Message}");
            AlertService.ShowError("Deployment Failed", "Failed to start multi-branch patch deployment.");
        }
        finally
        {
            IsDeployingToAll = false;
            StateHasChanged();
        }
    }

    private string SelectedStatusText = "All Status";

    private async Task OnStatusSelected(PatchStatus? status)
    {
        selectedStatus = status.ToString() ?? string.Empty;
        SelectedStatusText = status?.ToString() ?? "All Status";
        await LoadBranchesAsync();
    }

    // ====== API CALLS ====== [ALL REMAIN SAME]
    private async Task<string?> GetJwtToken()
    {
        try
        {
            var getJWT = new getJWTTokens(JSRuntime);
            return await getJWT.GetJWTLoggedInUserAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"JWT Error: {ex.Message}");
            return null;
        }
    }

    private async Task<LoggedInUser> getUserDetails()
    {
        return await _auth.getLogginUserDetiles();
    }

    public async Task<List<SelectBranchDtoWithSelectedPatchDto>?> getAllBranch(string baseUrl, string jwtToken)
    {
        try
        {
            var query = new List<string>
            {
                $"Search={Uri.EscapeDataString(searchText ?? string.Empty)}",
                $"SelectPatch={SelectPatchIf}"
            };

            if (!string.IsNullOrWhiteSpace(selectedStatus))
            {
                query.Add($"Status={Uri.EscapeDataString(selectedStatus)}");
            }

            if (SelectPatchIf && patchId > 0)
            {
                query.Add($"PatchId={patchId}");
            }

            var url = $"api/Branch/getAllBranchSelectedPatch?{string.Join("&", query)}";

            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

            var response = await client.GetAsync(url);
            var result = await response.Content.ReadFromJsonAsync<APIResponseOnlyList<SelectBranchDtoWithSelectedPatchDto>>();

            if (response.IsSuccessStatusCode)
            {
                if (result != null && result.StatusCode == 2 && result.Status == true)
                {
                    return result.ValueList;
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.BadRequest)
            {
                if (result != null && result.StatusCode == 1 && result.Status == false)
                {
                    AlertService.ShowError("Error", $"{result.Message}");
                    return null;
                }
                else if (result != null && result.StatusCode == 0 && result.Status == false)
                {
                    AlertService.ShowError("Error", $"{result.Message}");
                    Console.WriteLine($"Unexpected response: {response.StatusCode}");
                    return null;
                }
            }

            return null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.Message}");
            AlertService.ShowError("Error", $"API call failed: {ex.Message}");
            return null;
        }
    }

    private async Task<bool> getPatchesTypeAsync(string baseUrl, string jwtToken)
    {
        try
        {
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

            var response = await client.GetAsync("api/Patches/getPatchesTypes");
            var result = await response.Content.ReadFromJsonAsync<APIResponseCoustomizeList<SelectedAnyDropDownOrSamllData, NewPatch>>();

            if (response.IsSuccessStatusCode && result?.StatusCode == 2 && result.Status == true)
            {
                PatchTypeList = result.ValueList;
                return true;
            }

            HandleApiError(response, result);
            return false;
        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return false;
        }
    }

    private async Task<bool> getSelectedPatchesAsync(string baseUrl, string jwtToken, int patchtype)
    {
        try
        {
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

            var response = await client.GetAsync($"api/Patches/getSelectedPatches?patchtype={patchtype}");
            var result = await response.Content.ReadFromJsonAsync<APIResponseOnlyList<SelectedAnyDropDownOrSamllData>>();

            if (response.IsSuccessStatusCode && result?.StatusCode == 2 && result.Status == true)
            {
                SelectedPatchList = result.ValueList;
                return true;
            }

            HandleApiError(response, result);
            return false;
        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return false;
        }
    }

    private async Task<bool> getSelectedPatchAllAsync(string baseUrl, string jwtToken, int patchId)
    {
        try
        {
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

            var response = await client.GetAsync($"api/Patches/getSelectedPatchAllDetailsForAllBranch?patchId={patchId}");
            var result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<SelectedPatch>>();

            if (response.IsSuccessStatusCode && result?.StatusCode == 2 && result.Status == true)
            {
                SelectPatch = result.Value;
                return true;
            }

            HandleApiError(response, result);
            return false;
        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return false;
        }
    }

    private async Task<AllBranchPatchResponse?> PatchdeployAllBranches(string baseUrl, string jwtToken, APIRequestObject<AllBranchPatchRequest> obj)
    {
        try
        {
            using var client = new HttpClient { BaseAddress = new Uri(baseUrl) };
            client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", jwtToken);

            var response = await client.PostAsJsonAsync("api/Patches/PatchdeployAllBranches", obj);
            var result = await response.Content.ReadFromJsonAsync<APIResponseObjectValue<AllBranchPatchResponse>>();

            if (response.IsSuccessStatusCode && result?.StatusCode == 2 && result.Status == true)
            {
                return result.Value;
            }

            HandleApiError(response, result);
            return null;
        }
        catch (HttpRequestException ex)
        {
            AlertService.ShowError("Server Error", "Server fetch failed. Please contact support.");
            Console.WriteLine($"HttpRequestException: {ex.Message}");
            return null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"General Exception: {ex.Message}");
            return null;
        }
    }

    private void HandleApiError<T>(HttpResponseMessage response, T? result) where T : class
    {
        dynamic? dynResult = result;

        switch (response.StatusCode)
        {
            case HttpStatusCode.BadRequest:
            case HttpStatusCode.NotFound:
            case HttpStatusCode.Unauthorized:
                if (dynResult?.StatusCode == 1 && dynResult?.Status == false)
                {
                    AlertService.ShowError("Request Error", $"{dynResult?.Message}. Please try again.");
                }
                break;

            case HttpStatusCode.InternalServerError:
                if (dynResult?.StatusCode == 0 && dynResult?.Status == false)
                {
                    var serverMsg = dynResult?.Message ?? "Server error occurred.";
                    Console.WriteLine($"Server 500 response: {dynResult?.Ex}");
                    AlertService.ShowError("Server Error", $"{serverMsg}. Please contact support.");
                }
                break;
        }
    }

    // ====== DATA MODELS ======
    public class AllBranchPatchRequest
    {
        public int PatchId { get; set; }
        public List<int?> BranchIds { get; set; } = new();
        public string UserId { get; set; } = string.Empty;
    }

    public class AllBranchPatchResponse
    {
        public string JobId { get; set; } = string.Empty;
        public int PatchId { get; set; }
        public string PatchName { get; set; } = string.Empty;
        public int TotalBranches { get; set; }
        public int SuccessfulInitiations { get; set; }
        public int FailedInitiations { get; set; }
        public List<BranchDeploymentResult> DeploymentResults { get; set; } = new();
    }

    public class BranchDeploymentResult
    {
        public int BranchId { get; set; }
        public string BranchCode { get; set; } = string.Empty;
        public string BranchName { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
    }
}

<style>
    /* ====== ROOT & BASE ====== */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4caf50 0%, #81c784 100%);
        --danger-gradient: linear-gradient(135deg, #f44336 0%, #e57373 100%);
        --warning-gradient: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        --info-gradient: linear-gradient(135deg, #2196f3 0%, #64b5f6 100%);
        --bg-primary: #1a1a1b;
        --bg-secondary: #2a2a2b;
        --bg-tertiary: #252526;
        --border-color: rgba(100, 98, 100, 0.3);
        --text-primary: #ffffff;
        --text-secondary: #999;
        --text-muted: #666;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
        --transition-fast: 0.2s ease;
        --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
        box-sizing: border-box;
    }

    /* ====== MAIN LAYOUT ====== */
    .deployment-wrapper {
        background: #2a2a2b;
        display: flex;
        flex-direction: column;
    }

    .deployment-content {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 40px;
    }

    .deployment-section {
        background: linear-gradient(135deg, #3e3e3f 0%, #2a2a2b 100%);
        padding: 32px;
        border-radius: 16px;
        border: 2px solid rgba(100, 98, 100, 0.3);
    }

    /* ====== PAGE HEADER ====== */
    .page-header {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 32px;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
    }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

    .header-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .page-title {
        display: flex;
        align-items: center;
        gap: 16px;
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

        .page-title svg {
            color: #667eea;
        }

    .page-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 0;
        padding-left: 48px;
    }

    /* ====== DEPLOYMENT GRID ====== */
    .deployment-grid {
        display: grid;
        grid-template-columns: 480px 1fr;
        gap: 24px;
        min-height: calc(100vh - 280px);
    }

    /* ====== PANEL CARD ====== */
    .panel-card {
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100%;
    }

    .panel-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 20px 24px;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid var(--border-color);
    }

        .panel-card-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

    .header-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #953e3f;
        border-radius: 10px;
        color: var(--text-primary);
    }

    .header-left-section {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        justify-content: flex-end;
    }

    .panel-card-body {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    /* ====== DROPDOWN SECTION ====== */
    .dropdown-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .dropdown-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .dropdown-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .custom-dropdown {
        position: relative;
        width: 100%;
    }

    .custom-dropdown-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 18px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-base);
    }

        .custom-dropdown-btn:hover:not(:disabled) {
            background: rgba(149, 62, 63, 0.2);
            border-color: #953e3f;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            color: var(--text-primary);
        }

        .custom-dropdown-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: var(--text-primary);
        }

    .dropdown-text {
        flex: 1;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .dropdown-icon {
        flex-shrink: 0;
        color: var(--text-secondary);
        transition: transform var(--transition-fast);
    }

    .custom-dropdown-btn:hover .dropdown-icon {
        color: #953e3f;
    }

    .custom-dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        max-height: 300px;
        overflow-y: auto;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        animation: dropdownSlide 0.2s ease;
    }

    @@keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .custom-dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        color: var(--text-primary);
        font-size: 13px;
        cursor: pointer;
        transition: var(--transition-fast);
        border-bottom: 1px solid rgba(100, 98, 100, 0.1);
    }

        .custom-dropdown-item:last-child {
            border-bottom: none;
        }

        .custom-dropdown-item:hover {
            background: rgba(149, 62, 63, 0.2);
        }

        .custom-dropdown-item svg {
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .custom-dropdown-item:hover svg {
            color: #953e3f;
        }

    .dropdown-empty {
        display: block;
        padding: 12px 16px;
        color: var(--text-muted);
        font-size: 13px;
        text-align: center;
    }

    /* ====== PATCH DETAILS SECTION ====== */
    .patch-details-section {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .details-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 16px;
        min-height: 400px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px dashed var(--border-color);
        border-radius: 12px;
        padding: 32px;
    }

    .state-text {
        font-size: 14px;
        color: var(--text-secondary);
        text-align: center;
    }

    .empty-icon {
        opacity: 0.5;
    }

        .empty-icon svg {
            color: var(--text-secondary);
        }

    /* ====== PATCH INFO CARD ====== */
    .patch-info-card {
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
    }

    .patch-info-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .patch-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(76, 175, 80, 0.2);
        border-radius: 12px;
        color: #4caf50;
    }

    .patch-title-group {
        flex: 1;
    }

    .patch-version {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 4px 0;
    }

    .version-tag {
        font-size: 10px;
        font-weight: 700;
        color: var(--text-secondary);
        letter-spacing: 1px;
    }

    .patch-info-body {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .info-label {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

        .info-label svg {
            opacity: 0.7;
        }

    .info-value {
        font-size: 14px;
        color: var(--text-primary);
        word-break: break-word;
        line-height: 1.5;
    }

    .path-value {
        font-family: 'Courier New', monospace;
        font-size: 12px;
        background: rgba(0, 0, 0, 0.4);
        padding: 10px 12px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
    }

    /* ====== FILTER & SEARCH ====== */
    .status-filter-dropdown {
        position: relative;
    }

    .filter-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        color: #667eea;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-base);
        white-space: nowrap;
    }

        .filter-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .filter-btn svg {
            width: 14px;
            height: 14px;
        }

    .search-box {
        position: relative;
        width: 280px;
    }

    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        pointer-events: none;
    }

    .search-input {
        width: 100%;
        padding: 10px 16px 10px 40px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        transition: var(--transition-base);
    }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

    /* ====== SELECTION TOOLBAR ====== */
    .selection-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background: rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid var(--border-color);
        gap: 16px;
        flex-wrap: wrap;
    }

    .selection-info {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 600;
    }

        .selection-info svg {
            color: #667eea;
            flex-shrink: 0;
        }

    .selection-count {
        color: var(--text-primary);
    }

    .toolbar-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .toolbar-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-base);
        border: none;
        white-space: nowrap;
    }

    .select-btn {
        background: rgba(102, 126, 234, 0.2);
        color: #667eea;
        border: 1px solid rgba(102, 126, 234, 0.3);
    }

        .select-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

    .deselect-btn {
        background: rgba(158, 158, 158, 0.2);
        color: #9e9e9e;
        border: 1px solid rgba(158, 158, 158, 0.3);
    }

        .deselect-btn:hover {
            background: rgba(158, 158, 158, 0.3);
            transform: translateY(-2px);
        }

    .deploy-btn {
        background: linear-gradient(135deg, #953e3f 0%, #b04e4f 100%);
        color: white;
        border: none;
    }

        .deploy-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .deploy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

    /* ====== BRANCHES CONTAINER ====== */
    .branches-container {
        flex: 1;
        overflow-y: auto;
        padding: 5px 5px;
    }

    .branches-state {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 16px;
        min-height: 400px;
    }

    .branches-list {
        display: flex;
        flex-direction: column;
        gap: 10px;

    }

    /* ====== BRANCH ITEM ====== */
    .branch-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 18px;
        background: linear-gradient(135deg, rgba(42, 42, 43, 0.6) 0%, rgba(37, 37, 38, 0.8) 100%);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        transition: var(--transition-base);
        position: relative;
        overflow: hidden;
    }

        .branch-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .branch-item:hover:not(.disabled) {
            transform: translateX(4px);
            background: linear-gradient(135deg, rgba(42, 42, 43, 0.8) 0%, rgba(37, 37, 38, 1) 100%);
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: var(--shadow-sm);
        }

            .branch-item:hover:not(.disabled)::before {
                opacity: 1;
            }

        .branch-item.selected {
            border-color: rgba(102, 126, 234, 0.7);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(37, 37, 38, 0.9) 100%);
        }

            .branch-item.selected::before {
                opacity: 1;
            }

        .branch-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

            .branch-item.disabled:hover {
                transform: none;
                box-shadow: none;
                border-color: var(--border-color);
            }

    .branch-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        color: #667eea;
        flex-shrink: 0;
    }

        .branch-checkbox svg {
            width: 20px;
            height: 20px;
        }

    .branch-avatar {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(102, 126, 234, 0.2);
        border-radius: 12px;
        color: #667eea;
        flex-shrink: 0;
        transition: var(--transition-base);
    }

    .branch-item:hover:not(.disabled) .branch-avatar {
        background: rgba(102, 126, 234, 0.3);
        transform: scale(1.1);
    }

    .branch-main-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
    }

    .branch-name-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.3;
    }

    .branch-id-badge {
        padding: 2px 8px;
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        color: #667eea;
        white-space: nowrap;
    }

    .branch-terminal {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-secondary);
        font-family: 'Courier New', monospace;
    }

        .branch-terminal svg {
            opacity: 0.7;
        }

    .branch-status-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }

    .connection-badge {
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

        .connection-badge.online {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .connection-badge.offline {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

    .patch-status-badge {
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

        .patch-status-badge.success {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .patch-status-badge.failed {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .patch-status-badge.inprogress {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
            border: 1px solid rgba(33, 150, 243, 0.5);
        }

        .patch-status-badge.init {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid rgba(255, 152, 0, 0.5);
        }

        .patch-status-badge.rollback {
            background: rgba(156, 39, 176, 0.2);
            color: #9c27b0;
            border: 1px solid rgba(156, 39, 176, 0.5);
        }

        .patch-status-badge.notenroll {
            background: rgba(158, 158, 158, 0.2);
            color: #9e9e9e;
            border: 1px solid rgba(158, 158, 158, 0.5);
        }

        .patch-status-badge.restart {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.5);
        }

        .patch-status-badge.deactive {
            background: rgba(96, 96, 96, 0.2);
            color: #757575;
            border: 1px solid rgba(96, 96, 96, 0.5);
        }

    /* ====== SCROLLBAR ====== */
    .panel-card-body::-webkit-scrollbar,
    .branches-container::-webkit-scrollbar,
    .custom-dropdown-menu::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    .panel-card-body::-webkit-scrollbar-track,
    .branches-container::-webkit-scrollbar-track,
    .custom-dropdown-menu::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }

    .panel-card-body::-webkit-scrollbar-thumb,
    .branches-container::-webkit-scrollbar-thumb,
    .custom-dropdown-menu::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
    }

        .panel-card-body::-webkit-scrollbar-thumb:hover,
        .branches-container::-webkit-scrollbar-thumb:hover,
        .custom-dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

    /* ====== ANIMATIONS ====== */
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .branch-item {
        animation: fadeIn 0.3s ease;
    }

    .panel-card {
        animation: fadeIn 0.5s ease;
    }

    /* ====== RESPONSIVE ====== */
    @@media (max-width: 1400px) {
        .deployment-grid {
            grid-template-columns: 420px 1fr;
        }

        .search-box {
            width: 220px;
        }
    }

    @@media (max-width: 1200px) {
        .deployment-grid {
            grid-template-columns: 1fr;
        }

        .patch-selection-panel {
            max-width: 100%;
        }

        .header-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .search-box {
            width: 100%;
        }

        .selection-toolbar {
            flex-direction: column;
            align-items: stretch;
        }

        .toolbar-actions {
            width: 100%;
        }

        .toolbar-btn {
            flex: 1;
            justify-content: center;
        }
    }

    @@media (max-width: 768px) {
        .deployment-content {
            padding: 16px;
        }

        .page-header {
            padding: 20px;
        }

        .page-title {
            font-size: 22px;
        }

        .page-subtitle {
            padding-left: 38px;
        }

        .panel-card-body {
            padding: 16px;
        }

        .branches-container {
            padding: 12px 16px;
        }

        .branch-item {
            flex-wrap: wrap;
            gap: 12px;
        }

        .branch-status-group {
            width: 100%;
            justify-content: flex-start;
            padding-left: 40px;
        }

        .branch-name-row {
            flex-wrap: wrap;
        }
    }

    @@media (max-width: 480px) {
        .deployment-grid {
            gap: 16px;
        }

        .panel-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .header-actions {
            width: 100%;
        }

        .toolbar-actions {
            flex-direction: column;
        }

        .branch-avatar {
            width: 40px;
            height: 40px;
        }

        .branch-name-row {
            font-size: 14px;
        }

        .branch-id-badge {
            font-size: 10px;
        }
    }
</style>